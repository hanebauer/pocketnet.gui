(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{519:function(e,t,s){"use strict";s.r(t),s.d(t,"P2pMediaLoaderPlugin",(function(){return y}));var i=s(0),a=s.n(i),r=s(516),n=s(201),o=s(3),l=s(330),h=s.n(l),d=s(512);class c{constructor(e){this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.paused=!0,this.hls.pauseCapping=()=>{this.paused=!0},this.hls.resumeCapping=()=>{this.paused=!1},this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(d.a.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(d.a.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(d.a.MANIFEST_PARSED,this.onManifestParsed,this),e.on(d.a.BUFFER_CODECS,this.onBufferCodecs,this),e.on(d.a.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(d.a.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(d.a.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(d.a.MANIFEST_PARSED,this.onManifestParsed,this),e.off(d.a.BUFFER_CODECS,this.onBufferCodecs,this),e.off(d.a.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){c.isLevelAllowed(t.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(t.droppedLevel)}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null}onManifestParsed(e,t){const s=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,s.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){const e=this.hls.levels;if(e.length){const t=this.hls;t.autoLevelCapping=this.getMaxLevel(e.length-1),t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const s=t.filter(((t,s)=>c.isLevelAllowed(s,this.restrictedLevels)&&s<=e));return this.clientRect=null,c.getMaxLevelByMediaSize(s,this.mediaWidth,this.mediaHeight)}capp(){this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),this.detectPlayerSize()}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e4),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.paused&&this.clientRectLast)return this.clientRectLast;if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const s=e.getBoundingClientRect();t.width=s.width,t.height=s.height,t.width||t.height||(t.width=s.right-s.left||e.width||0,t.height=s.bottom-s.top||e.height||0)}return this.clientRectLast=this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*c.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*c.contentScaleFactor}static get contentScaleFactor(){let e=1;try{e=self.devicePixelRatio}catch(e){}return e>1.5&&(e=1.5),e}static isLevelAllowed(e,t=[]){return-1===t.indexOf(e)}static getMaxLevelByMediaSize(e,t,s){if(!e||!e.length)return-1;let i=e.length-1;for(let n=0;n<e.length;n+=1){const o=e[n];if((o.width>=t||o.height>=s)&&(a=o,!(r=e[n+1])||a.width!==r.width||a.height!==r.height)){i=n;break}}var a,r;return i}}var p=c;function u(e){const t=this;e&&(t.srOptions_||(t.srOptions_={}),t.srOptions_.hlsjsConfig||(t.srOptions_.hlsjsConfig=e.hlsjsConfig),t.srOptions_.captionConfig||(t.srOptions_.captionConfig=e.captionConfig),e.levelLabelHandler&&!t.srOptions_.levelLabelHandler&&(t.srOptions_.levelLabelHandler=e.levelLabelHandler))}class g{constructor(e,t,s){this.errorCounts={},this.hlsjsConfig=null,this._duration=null,this.metadata=null,this.isLive=null,this.dvrDuration=null,this.edgeMargin=null,this.handlers={play:null,playing:null,textTracksChange:null,audioTracksChange:null},this.uiTextTrackHandled=!1,this.vjs=e,this.source=t,this.tech=s,this.tech.name_="Hlsjs",this.videoElement=s.el(),this.player=e(s.options_.playerId),this.videoElement.addEventListener("error",(e=>{let t;const s=(e.currentTarget||e.target).error;if(s)switch(s.code){case s.MEDIA_ERR_ABORTED:t="You aborted the video playback";break;case s.MEDIA_ERR_DECODE:t="The video playback was aborted due to a corruption problem or because the video used features your browser did not support",this._handleMediaError(s);break;case s.MEDIA_ERR_NETWORK:t="A network error caused the video download to fail part-way";break;case s.MEDIA_ERR_SRC_NOT_SUPPORTED:t="The video could not be loaded, either because the server or network failed or because the format is not supported";break;default:t=s.message}})),this.initialize()}duration(){return this._duration||this.videoElement.duration||0}seekable(){if(this.hls.media){if(!this.isLive)return this.vjs.createTimeRanges(0,this.hls.media.duration);const e=Math.round(this.hls.media.duration-this.dvrDuration),t=Math.round(this.hls.media.duration-this.edgeMargin);return this.vjs.createTimeRanges(e,t)}return this.vjs.createTimeRanges()}dispose(){this.videoElement.removeEventListener("play",this.handlers.play),this.videoElement.removeEventListener("playing",this.handlers.playing),this.player.textTracks().removeEventListener("change",this.handlers.textTracksChange),this.uiTextTrackHandled=!1,this.hls.destroy(),this.handlers=null}static addHook(e,t){g.hooks[e]=this.hooks[e]||[],g.hooks[e].push(t)}static removeHook(e,t){if(void 0===g.hooks[e])return!1;const s=g.hooks[e].indexOf(t);return-1!==s&&(g.hooks[e].splice(s,1),!0)}_executeHooksFor(e){if(void 0!==g.hooks[e])for(let t=0;t<g.hooks[e].length;t++)g.hooks[e][t](this.player,this.hls)}_handleMediaError(e){return 1===this.errorCounts[l.ErrorTypes.MEDIA_ERROR]?(console.info("trying to recover media error"),void this.hls.recoverMediaError()):2===this.errorCounts[l.ErrorTypes.MEDIA_ERROR]?(console.info("2nd try to recover media error (by swapping audio codec"),this.hls.swapAudioCodec(),void this.hls.recoverMediaError()):this.errorCounts[l.ErrorTypes.MEDIA_ERROR]>2?(console.info("bubbling media error up to VIDEOJS"),void this.hls.recoverMediaError()):void 0}_handleNotFatalError(e){this.tech.trigger("error")}_handleNetworkError(e){if(setTimeout((()=>this.hls.startLoad()),1e3),this.errorCounts[l.ErrorTypes.NETWORK_ERROR]<=1)return console.info("trying to recover network error",e),setTimeout((()=>this.hls.startLoad()),1e3),void this.hls.once(l.Events.FRAG_LOADED,(()=>{this.errorCounts[l.ErrorTypes.NETWORK_ERROR]=0}));console.info("bubbling network error up to VIDEOJS"),this.tech.error=()=>e,this.tech.trigger("error")}_onError(e,t){const s={message:`HLS.js error: ${t.type} - fatal: ${t.fatal} - ${t.details}`};console.log("d",t),t.fatal&&(this.errorCounts[t.type]?this.errorCounts[t.type]+=1:this.errorCounts[t.type]=1,t.type===l.ErrorTypes.NETWORK_ERROR?(s.code=2,this._handleNetworkError(s)):t.type===l.ErrorTypes.MEDIA_ERROR&&"manifestIncompatibleCodecsError"!==t.details?(s.code=3,this._handleMediaError(s)):(this.tech.error=()=>s,this.tech.trigger("error")))}switchQuality(e){this.hls.nextLevel=e}_levelLabel(e){return this.player.srOptions_.levelLabelHandler?this.player.srOptions_.levelLabelHandler(e):e.height?e.height+"p":e.width?Math.round(9*e.width/16)+"p":e.bitrate?e.bitrate/1e3+"kbps":0}_relayQualityChange(e){let t,s=!0;for(let t=0;t<e.length;t++)if(!e[t]._enabled){s=!1;break}if(s)this.hls.currentLevel=-1;else{for(t=e.length-1;t>=0&&!e[t]._enabled;t--);this.hls.currentLevel=t}}_handleQualityLevels(){if(!this.metadata)return;const e=this.player.qualityLevels&&this.player.qualityLevels();if(e)for(let t=0;t<this.metadata.levels.length;t++){const s=this.metadata.levels[t],i={id:t,width:s.width,height:s.height,bandwidth:s.bitrate,bitrate:s.bitrate,_enabled:!0},a=this;i.enabled=function(e,t){return"boolean"==typeof t&&(this[e]._enabled=t,a._relayQualityChange(this)),this[e]._enabled},e.addQualityLevel(i)}}_notifyVideoQualities(){if(!this.metadata)return;const e=[];if(this.metadata.levels.length>1){const t={id:-1,label:"auto",selected:-1===this.hls.manualLevel};e.push(t)}this.metadata.levels.forEach(((t,s)=>{const i={id:s,selected:s===this.hls.manualLevel,label:this._levelLabel(t)};e.push(i)}));const t={qualityData:{video:e},qualitySwitchCallback:this.switchQuality.bind(this)};this.tech.trigger("loadedqualitydata",t),this.videoElement.removeEventListener("playing",this.handlers.playing)}_updateSelectedAudioTrack(){const e=this.tech.audioTracks();for(let t=0;t<e.length;t++)if(e[t].enabled){this.hls.audioTrack=t;break}}_onAudioTracks(){const e=this.hls.audioTracks,t=this.tech.audioTracks();if(e.length>1&&0===t.length){for(let s=0;s<e.length;s++)t.addTrack(new this.vjs.AudioTrack({id:s.toString(),kind:"alternative",label:e[s].name||e[s].lang,language:e[s].lang,enabled:s===this.hls.audioTrack}));this.handlers.audioTracksChange=this._updateSelectedAudioTrack.bind(this),t.addEventListener("change",this.handlers.audioTracksChange)}}_getTextTrackLabel(e){return e.label?e.label:e.language}_isSameTextTrack(e,t){return this._getTextTrackLabel(e)===this._getTextTrackLabel(t)&&e.kind===t.kind}_updateSelectedTextTrack(){const e=this.player.textTracks();let t=null;for(let s=0;s<e.length;s++)if("showing"===e[s].mode){t=e[s];break}const s=this.videoElement.textTracks;for(let e=0;e<s.length;e++)"subtitles"!==s[e].kind&&"captions"!==s[e].kind||(s[e].mode=t&&this._isSameTextTrack(s[e],t)?"showing":"disabled")}_startLoad(){this.hls.startLoad(-1),this.videoElement.removeEventListener("play",this.handlers.play)}_oneLevelObjClone(e){const t={},s=Object.keys(e);for(let i=0;i<s.length;i++)t[s[i]]=e[s[i]];return t}_filterDisplayableTextTracks(e){const t=[];for(let s=0;s<e.length;s++)"subtitles"!==e[s].kind&&"captions"!==e[s].kind||t.push(e[s]);return t}_updateTextTrackList(){const e=this._filterDisplayableTextTracks(this.videoElement.textTracks),t=this.player.textTracks();for(let s=0;s<e.length;s++){let i=!1;for(let a=0;a<t.length;a++)if(this._isSameTextTrack(e[s],t[a])){i=!0;break}if(!i){const t=e[s];this.player.addRemoteTextTrack({kind:t.kind,label:this._getTextTrackLabel(t),language:t.language,srclang:t.language},!1)}}this._updateSelectedTextTrack(),this.uiTextTrackHandled||(this.handlers.textTracksChange=this._updateSelectedTextTrack.bind(this),t.addEventListener("change",this.handlers.textTracksChange),this.uiTextTrackHandled=!0)}_onMetaData(e,t){this.metadata=t,this._handleQualityLevels()}_createCueHandler(e){return{newCue:(t,s,i,a)=>{let r,n,o;const l=window.VTTCue||window.TextTrackCue;for(let h=0;h<a.rows.length;h++)if(r=a.rows[h],o="",!r.isEmpty()){for(let e=0;e<r.chars.length;e++)o+=r.chars[e].ucharj;if(n=new l(s,i,o.trim()),null!=e&&"object"==typeof e){const t=Object.keys(e);for(let s=0;s<t.length;s++)n[t[s]]=e[t[s]]}t.addCue(n),i===s&&t.addCue(new l(i+5,""))}}}}_initHlsjs(){const e=this.tech.options_,t=this.player.srOptions_,s=t&&t.hlsjsConfig||e.hlsjsConfig;this.hlsjsConfig=s?this._oneLevelObjClone(s):{},["","auto"].includes(this.videoElement.preload)&&!this.videoElement.autoplay&&void 0===this.hlsjsConfig.autoStartLoad&&(this.hlsjsConfig.autoStartLoad=!1);const i=t&&t.captionConfig||e.captionConfig;i&&(this.hlsjsConfig.cueHandler=this._createCueHandler(i)),!1===this.hlsjsConfig.autoStartLoad&&(this.handlers.play=this._startLoad.bind(this),this.videoElement.addEventListener("play",this.handlers.play)),this.handlers.playing=this._notifyVideoQualities.bind(this),this.videoElement.addEventListener("playing",this.handlers.playing),this.hlsjsConfig.capLevelController=p,this.hls=new h.a(this.hlsjsConfig),this._executeHooksFor("beforeinitialize"),this.hls.on(l.Events.ERROR,((e,t)=>this._onError(e,t))),this.hls.on(l.Events.AUDIO_TRACKS_UPDATED,(()=>this._onAudioTracks())),this.hls.on(l.Events.MANIFEST_PARSED,((e,t)=>this._onMetaData(e,t))),this.hls.on(l.Events.LEVEL_LOADED,((e,t)=>{this.hlsjsConfig.liveSyncDuration?this.edgeMargin=this.hlsjsConfig.liveSyncDuration:this.hlsjsConfig.liveSyncDurationCount&&(this.edgeMargin=this.hlsjsConfig.liveSyncDurationCount*t.details.targetduration),this.isLive=t.details.live,this.dvrDuration=t.details.totalduration,this._duration=this.isLive?1/0:t.details.totalduration})),this.hls.once(l.Events.FRAG_LOADED,(()=>{this.tech.trigger("loadedmetadata")})),this.hls.attachMedia(this.videoElement),this.hls.loadSource(this.source.src)}initialize(){this._initHlsjs()}}var v;g.hooks={},((v=a.a).registerPlugin||v.plugin)("hlsjs",u),function(e){if(!h.a.isSupported())return void console.warn("Hls.js is not supported in this browser!");const t=e.getTech("Html5");t?(t.registerSourceHandler({canHandleSource:function(e){return/^application\/x-mpegURL|application\/vnd\.apple\.mpegurl$/i.test(e.type)?"probably":/\.m3u8/i.test(e.src)?"maybe":""},handleSource:function(t,s){return s.hlsProvider&&s.hlsProvider.dispose(),s.hlsProvider=new g(e,t,s),s.hlsProvider}},0),e.Html5Hlsjs=g):console.error("Not supported version if video.js")}(a.a);const f=a.a.getPlugin("plugin");class y extends f{constructor(e,t){if(super(e),this.CONSTANTS={INFO_SCHEDULER:1e3},this.statsP2PBytes={pendingDownload:[],pendingUpload:[],numPeers:0,totalDownload:0,totalUpload:0},this.statsHTTPBytes={pendingDownload:[],pendingUpload:[],totalDownload:0,totalUpload:0},this.options=t,a.a.Html5Hlsjs)a.a.Html5Hlsjs.addHook("beforeinitialize",((e,t)=>{this.hlsjs=t})),Object(r.initVideoJsContribHlsJsPlayer)(e);else if(console.warn("HLS.js does not seem to be supported. Try to fallback to built in HLS."),!e.canPlayType("application/vnd.apple.mpegurl")){const t="Cannot fallback to built-in HLS";return console.warn(t),void e.ready((()=>e.trigger("error",new Error(t))))}t&&(this.startTime=Object(o.j)(t.startTime),e.src({type:t.type,src:t.src})),e.ready((()=>{this.initializeCore(),a.a.Html5Hlsjs&&t&&this.initializePlugin()}))}dispose(){this.hlsjs&&this.hlsjs.destroy(),this.p2pEngine&&this.p2pEngine.destroy(),clearInterval(this.networkInfoInterval)}getHLSJS(){return this.hlsjs}initializeCore(){this.player.one("play",(()=>{this.player.addClass("vjs-has-big-play-button-clicked")})),this.player.one("canplay",(()=>{this.startTime&&this.player.currentTime(this.startTime)}))}initializePlugin(){Object(r.initHlsJsPlayer)(this.hlsjs);const e=this.player.tech(!0).options_;this.p2pEngine=e.hlsjsConfig.loader.getEngine(),this.hlsjs.on(l.Events.LEVEL_SWITCHING,((e,t)=>{this.trigger("resolutionChange",{auto:this.hlsjs.autoLevelEnabled,resolutionId:t.height})})),this.p2pEngine.on(n.a.SegmentError,((e,t)=>{this.options.redundancyUrlManager.removeBySegmentUrl(e.requestUrl)})),this.statsP2PBytes.numPeers=1+this.options.redundancyUrlManager.countBaseUrls(),this.runStats()}runStats(){this.p2pEngine.on(n.a.PieceBytesDownloaded,((e,t,s)=>{const i="p2p"===e?this.statsP2PBytes:this.statsHTTPBytes;i.pendingDownload.push(s),i.totalDownload+=s})),this.p2pEngine.on(n.a.PieceBytesUploaded,((e,t,s)=>{const i="p2p"===e?this.statsP2PBytes:this.statsHTTPBytes;i.pendingUpload.push(s),i.totalUpload+=s})),this.p2pEngine.on(n.a.PeerConnect,(()=>this.statsP2PBytes.numPeers++)),this.p2pEngine.on(n.a.PeerClose,(()=>this.statsP2PBytes.numPeers--)),this.networkInfoInterval=setInterval((()=>{const e=this.arraySum(this.statsP2PBytes.pendingDownload),t=this.arraySum(this.statsP2PBytes.pendingUpload),s=this.arraySum(this.statsHTTPBytes.pendingDownload),i=this.arraySum(this.statsHTTPBytes.pendingUpload);return this.statsP2PBytes.pendingDownload=[],this.statsP2PBytes.pendingUpload=[],this.statsHTTPBytes.pendingDownload=[],this.statsHTTPBytes.pendingUpload=[],this.player.trigger("p2pInfo",{source:"p2p-media-loader",http:{downloadSpeed:s,uploadSpeed:i,downloaded:this.statsHTTPBytes.totalDownload,uploaded:this.statsHTTPBytes.totalUpload},p2p:{downloadSpeed:e,uploadSpeed:t,numPeers:this.statsP2PBytes.numPeers,downloaded:this.statsP2PBytes.totalDownload,uploaded:this.statsP2PBytes.totalUpload}})}),this.CONSTANTS.INFO_SCHEDULER)}arraySum(e){return e.reduce(((e,t)=>e+t),0)}}a.a.registerPlugin("p2pMediaLoader",y)}}]);
//# sourceMappingURL=10.chunk.js.map