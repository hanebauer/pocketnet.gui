/*! For license information please see 819.chunk.js.LICENSE.txt */
(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[819],{6026:(e,t,n)=>{"use strict";function r(e,t){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},r(e,t)}function i(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,r(e,t)}n.r(t),n.d(t,{LineStream:()=>g,ParseStream:()=>f,Parser:()=>b});var s=function(){function e(){this.listeners={}}var t=e.prototype;return t.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},t.off=function(e,t){if(!this.listeners[e])return!1;var n=this.listeners[e].indexOf(t);return this.listeners[e]=this.listeners[e].slice(0),this.listeners[e].splice(n,1),n>-1},t.trigger=function(e){var t=this.listeners[e];if(t)if(2===arguments.length)for(var n=t.length,r=0;r<n;++r)t[r].call(this,arguments[1]);else for(var i=Array.prototype.slice.call(arguments,1),s=t.length,a=0;a<s;++a)t[a].apply(this,i)},t.dispose=function(){this.listeners={}},t.pipe=function(e){this.on("data",(function(t){e.push(t)}))},e}();function a(){return a=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},a.apply(this,arguments)}var o=n(7688),u=n.n(o),d=n(2236).Buffer;function l(e){for(var t,n=(t=e,u().atob?u().atob(t):d.from(t,"base64").toString("binary")),r=new Uint8Array(n.length),i=0;i<n.length;i++)r[i]=n.charCodeAt(i);return r}var g=function(e){function t(){var t;return(t=e.call(this)||this).buffer="",t}return i(t,e),t.prototype.push=function(e){var t;for(this.buffer+=e,t=this.buffer.indexOf("\n");t>-1;t=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,t)),this.buffer=this.buffer.substring(t+1)},t}(s),c=String.fromCharCode(9),m=function(e){var t=/([0-9.]*)?@?([0-9.]*)?/.exec(e||""),n={};return t[1]&&(n.length=parseInt(t[1],10)),t[2]&&(n.offset=parseInt(t[2],10)),n},p=function(e){for(var t,n=e.split(new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')),r={},i=n.length;i--;)""!==n[i]&&((t=/([^=]*)=(.*)/.exec(n[i]).slice(1))[0]=t[0].replace(/^\s+|\s+$/g,""),t[1]=t[1].replace(/^\s+|\s+$/g,""),t[1]=t[1].replace(/^['"](.*)['"]$/g,"$1"),r[t[0]]=t[1]);return r},f=function(e){function t(){var t;return(t=e.call(this)||this).customParsers=[],t.tagMappers=[],t}i(t,e);var n=t.prototype;return n.push=function(e){var t,n,r=this;0!==(e=e.trim()).length&&("#"===e[0]?this.tagMappers.reduce((function(t,n){var r=n(e);return r===e?t:t.concat([r])}),[e]).forEach((function(e){for(var i=0;i<r.customParsers.length;i++)if(r.customParsers[i].call(r,e))return;if(0===e.indexOf("#EXT"))if(e=e.replace("\r",""),t=/^#EXTM3U/.exec(e))r.trigger("data",{type:"tag",tagType:"m3u"});else{if(t=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(e))return n={type:"tag",tagType:"inf"},t[1]&&(n.duration=parseFloat(t[1])),t[2]&&(n.title=t[2]),void r.trigger("data",n);if(t=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(e))return n={type:"tag",tagType:"targetduration"},t[1]&&(n.duration=parseInt(t[1],10)),void r.trigger("data",n);if(t=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(e))return n={type:"tag",tagType:"version"},t[1]&&(n.version=parseInt(t[1],10)),void r.trigger("data",n);if(t=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(e))return n={type:"tag",tagType:"media-sequence"},t[1]&&(n.number=parseInt(t[1],10)),void r.trigger("data",n);if(t=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(e))return n={type:"tag",tagType:"discontinuity-sequence"},t[1]&&(n.number=parseInt(t[1],10)),void r.trigger("data",n);if(t=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(e))return n={type:"tag",tagType:"playlist-type"},t[1]&&(n.playlistType=t[1]),void r.trigger("data",n);if(t=/^#EXT-X-BYTERANGE:?(.*)?$/.exec(e))return n=a(m(t[1]),{type:"tag",tagType:"byterange"}),void r.trigger("data",n);if(t=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(e))return n={type:"tag",tagType:"allow-cache"},t[1]&&(n.allowed=!/NO/.test(t[1])),void r.trigger("data",n);if(t=/^#EXT-X-MAP:?(.*)$/.exec(e)){if(n={type:"tag",tagType:"map"},t[1]){var s=p(t[1]);s.URI&&(n.uri=s.URI),s.BYTERANGE&&(n.byterange=m(s.BYTERANGE))}r.trigger("data",n)}else if(t=/^#EXT-X-STREAM-INF:?(.*)$/.exec(e)){if(n={type:"tag",tagType:"stream-inf"},t[1]){if(n.attributes=p(t[1]),n.attributes.RESOLUTION){var o=n.attributes.RESOLUTION.split("x"),u={};o[0]&&(u.width=parseInt(o[0],10)),o[1]&&(u.height=parseInt(o[1],10)),n.attributes.RESOLUTION=u}n.attributes.BANDWIDTH&&(n.attributes.BANDWIDTH=parseInt(n.attributes.BANDWIDTH,10)),n.attributes["PROGRAM-ID"]&&(n.attributes["PROGRAM-ID"]=parseInt(n.attributes["PROGRAM-ID"],10))}r.trigger("data",n)}else{if(t=/^#EXT-X-MEDIA:?(.*)$/.exec(e))return n={type:"tag",tagType:"media"},t[1]&&(n.attributes=p(t[1])),void r.trigger("data",n);if(t=/^#EXT-X-ENDLIST/.exec(e))r.trigger("data",{type:"tag",tagType:"endlist"});else if(t=/^#EXT-X-DISCONTINUITY/.exec(e))r.trigger("data",{type:"tag",tagType:"discontinuity"});else{if(t=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(e))return n={type:"tag",tagType:"program-date-time"},t[1]&&(n.dateTimeString=t[1],n.dateTimeObject=new Date(t[1])),void r.trigger("data",n);if(t=/^#EXT-X-KEY:?(.*)$/.exec(e))return n={type:"tag",tagType:"key"},t[1]&&(n.attributes=p(t[1]),n.attributes.IV&&("0x"===n.attributes.IV.substring(0,2).toLowerCase()&&(n.attributes.IV=n.attributes.IV.substring(2)),n.attributes.IV=n.attributes.IV.match(/.{8}/g),n.attributes.IV[0]=parseInt(n.attributes.IV[0],16),n.attributes.IV[1]=parseInt(n.attributes.IV[1],16),n.attributes.IV[2]=parseInt(n.attributes.IV[2],16),n.attributes.IV[3]=parseInt(n.attributes.IV[3],16),n.attributes.IV=new Uint32Array(n.attributes.IV))),void r.trigger("data",n);if(t=/^#EXT-X-START:?(.*)$/.exec(e))return n={type:"tag",tagType:"start"},t[1]&&(n.attributes=p(t[1]),n.attributes["TIME-OFFSET"]=parseFloat(n.attributes["TIME-OFFSET"]),n.attributes.PRECISE=/YES/.test(n.attributes.PRECISE)),void r.trigger("data",n);if(t=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(e))return(n={type:"tag",tagType:"cue-out-cont"}).data=t[1]?t[1]:"",void r.trigger("data",n);if(t=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(e))return(n={type:"tag",tagType:"cue-out"}).data=t[1]?t[1]:"",void r.trigger("data",n);if(t=/^#EXT-X-CUE-IN:?(.*)?$/.exec(e))return(n={type:"tag",tagType:"cue-in"}).data=t[1]?t[1]:"",void r.trigger("data",n);if((t=/^#EXT-X-SKIP:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"skip"}).attributes=p(t[1]),n.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(n.attributes["SKIPPED-SEGMENTS"]=parseInt(n.attributes["SKIPPED-SEGMENTS"],10)),n.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(n.attributes["RECENTLY-REMOVED-DATERANGES"]=n.attributes["RECENTLY-REMOVED-DATERANGES"].split(c)),void r.trigger("data",n);if((t=/^#EXT-X-PART:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"part"}).attributes=p(t[1]),["DURATION"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=parseFloat(n.attributes[e]))})),["INDEPENDENT","GAP"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=/YES/.test(n.attributes[e]))})),n.attributes.hasOwnProperty("BYTERANGE")&&(n.attributes.byterange=m(n.attributes.BYTERANGE)),void r.trigger("data",n);if((t=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"server-control"}).attributes=p(t[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=parseFloat(n.attributes[e]))})),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=/YES/.test(n.attributes[e]))})),void r.trigger("data",n);if((t=/^#EXT-X-PART-INF:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"part-inf"}).attributes=p(t[1]),["PART-TARGET"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=parseFloat(n.attributes[e]))})),void r.trigger("data",n);if((t=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"preload-hint"}).attributes=p(t[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach((function(e){if(n.attributes.hasOwnProperty(e)){n.attributes[e]=parseInt(n.attributes[e],10);var t="BYTERANGE-LENGTH"===e?"length":"offset";n.attributes.byterange=n.attributes.byterange||{},n.attributes.byterange[t]=n.attributes[e],delete n.attributes[e]}})),void r.trigger("data",n);if((t=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(e))&&t[1])return(n={type:"tag",tagType:"rendition-report"}).attributes=p(t[1]),["LAST-MSN","LAST-PART"].forEach((function(e){n.attributes.hasOwnProperty(e)&&(n.attributes[e]=parseInt(n.attributes[e],10))})),void r.trigger("data",n);r.trigger("data",{type:"tag",data:e.slice(4)})}}}else r.trigger("data",{type:"comment",text:e.slice(1)})})):this.trigger("data",{type:"uri",uri:e}))},n.addParser=function(e){var t=this,n=e.expression,r=e.customType,i=e.dataParser,s=e.segment;"function"!=typeof i&&(i=function(e){return e}),this.customParsers.push((function(e){if(n.exec(e))return t.trigger("data",{type:"custom",data:i(e),customType:r,segment:s}),!0}))},n.addTagMapper=function(e){var t=e.expression,n=e.map;this.tagMappers.push((function(e){return t.test(e)?n(e):e}))},t}(s),h=function(e){var t={};return Object.keys(e).forEach((function(n){var r;t[(r=n,r.toLowerCase().replace(/-(\w)/g,(function(e){return e[1].toUpperCase()})))]=e[n]})),t},y=function(e){var t=e.serverControl,n=e.targetDuration,r=e.partTargetDuration;if(t){var i="#EXT-X-SERVER-CONTROL",s="holdBack",a="partHoldBack",o=n&&3*n,u=r&&2*r;n&&!t.hasOwnProperty(s)&&(t[s]=o,this.trigger("info",{message:i+" defaulting HOLD-BACK to targetDuration * 3 ("+o+")."})),o&&t[s]<o&&(this.trigger("warn",{message:i+" clamping HOLD-BACK ("+t[s]+") to targetDuration * 3 ("+o+")"}),t[s]=o),r&&!t.hasOwnProperty(a)&&(t[a]=3*r,this.trigger("info",{message:i+" defaulting PART-HOLD-BACK to partTargetDuration * 3 ("+t[a]+")."})),r&&t[a]<u&&(this.trigger("warn",{message:i+" clamping PART-HOLD-BACK ("+t[a]+") to partTargetDuration * 2 ("+u+")."}),t[a]=u)}},b=function(e){function t(){var t;(t=e.call(this)||this).lineStream=new g,t.parseStream=new f,t.lineStream.pipe(t.parseStream);var n,r,i=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t),s=[],o={},u=!1,d=function(){},c={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},m=0;t.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};var p=0,b=0;return t.on("end",(function(){o.uri||!o.parts&&!o.preloadHints||(!o.map&&n&&(o.map=n),!o.key&&r&&(o.key=r),o.timeline||"number"!=typeof m||(o.timeline=m),t.manifest.preloadSegment=o)})),t.parseStream.on("data",(function(e){var t,g;({tag:function(){({version:function(){e.version&&(this.manifest.version=e.version)},"allow-cache":function(){this.manifest.allowCache=e.allowed,"allowed"in e||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var t={};"length"in e&&(o.byterange=t,t.length=e.length,"offset"in e||(e.offset=p)),"offset"in e&&(o.byterange=t,t.offset=e.offset),p=t.offset+t.length},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),e.duration>0&&(o.duration=e.duration),0===e.duration&&(o.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=s},key:function(){if(e.attributes)if("NONE"!==e.attributes.METHOD)if(e.attributes.URI){if("com.apple.streamingkeydelivery"===e.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:e.attributes});if("com.microsoft.playready"===e.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.microsoft.playready"]={uri:e.attributes.URI});if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===e.attributes.KEYFORMAT)return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(e.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===e.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==e.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):e.attributes.KEYID&&"0x"===e.attributes.KEYID.substring(0,2)?(this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:e.attributes.KEYFORMAT,keyId:e.attributes.KEYID.substring(2)},pssh:l(e.attributes.URI.split(",")[1])})):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}));e.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),r={method:e.attributes.METHOD||"AES-128",uri:e.attributes.URI},void 0!==e.attributes.IV&&(r.iv=e.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else r=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){isFinite(e.number)?this.manifest.mediaSequence=e.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+e.number})},"discontinuity-sequence":function(){isFinite(e.number)?(this.manifest.discontinuitySequence=e.number,m=e.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+e.number})},"playlist-type":function(){/VOD|EVENT/.test(e.playlistType)?this.manifest.playlistType=e.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+e.playlist})},map:function(){n={},e.uri&&(n.uri=e.uri),e.byterange&&(n.byterange=e.byterange),r&&(n.key=r)},"stream-inf":function(){this.manifest.playlists=s,this.manifest.mediaGroups=this.manifest.mediaGroups||c,e.attributes?(o.attributes||(o.attributes={}),a(o.attributes,e.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media:function(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||c,e.attributes&&e.attributes.TYPE&&e.attributes["GROUP-ID"]&&e.attributes.NAME){var n=this.manifest.mediaGroups[e.attributes.TYPE];n[e.attributes["GROUP-ID"]]=n[e.attributes["GROUP-ID"]]||{},t=n[e.attributes["GROUP-ID"]],(g={default:/yes/i.test(e.attributes.DEFAULT)}).autoselect=!!g.default||/yes/i.test(e.attributes.AUTOSELECT),e.attributes.LANGUAGE&&(g.language=e.attributes.LANGUAGE),e.attributes.URI&&(g.uri=e.attributes.URI),e.attributes["INSTREAM-ID"]&&(g.instreamId=e.attributes["INSTREAM-ID"]),e.attributes.CHARACTERISTICS&&(g.characteristics=e.attributes.CHARACTERISTICS),e.attributes.FORCED&&(g.forced=/yes/i.test(e.attributes.FORCED)),t[e.attributes.NAME]=g}else this.trigger("warn",{message:"ignoring incomplete or missing media group"})},discontinuity:function(){m+=1,o.discontinuity=!0,this.manifest.discontinuityStarts.push(s.length)},"program-date-time":function(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=e.dateTimeString,this.manifest.dateTimeObject=e.dateTimeObject),o.dateTimeString=e.dateTimeString,o.dateTimeObject=e.dateTimeObject},targetduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+e.duration}):(this.manifest.targetDuration=e.duration,y.call(this,this.manifest))},start:function(){e.attributes&&!isNaN(e.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:e.attributes["TIME-OFFSET"],precise:e.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out":function(){o.cueOut=e.data},"cue-out-cont":function(){o.cueOutCont=e.data},"cue-in":function(){o.cueIn=e.data},skip:function(){this.manifest.skip=h(e.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",e.attributes,["SKIPPED-SEGMENTS"])},part:function(){var t=this;u=!0;var n=this.manifest.segments.length,r=h(e.attributes);o.parts=o.parts||[],o.parts.push(r),r.byterange&&(r.byterange.hasOwnProperty("offset")||(r.byterange.offset=b),b=r.byterange.offset+r.byterange.length),this.warnOnMissingAttributes_("#EXT-X-PART #"+(o.parts.length-1)+" for segment #"+n,e.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((function(e,n){e.hasOwnProperty("lastPart")||t.trigger("warn",{message:"#EXT-X-RENDITION-REPORT #"+n+" lacks required attribute(s): LAST-PART"})}))},"server-control":function(){var t=this.manifest.serverControl=h(e.attributes);t.hasOwnProperty("canBlockReload")||(t.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),y.call(this,this.manifest),t.canSkipDateranges&&!t.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint":function(){var t=this.manifest.segments.length,n=h(e.attributes),r=n.type&&"PART"===n.type;o.preloadHints=o.preloadHints||[],o.preloadHints.push(n),n.byterange&&(n.byterange.hasOwnProperty("offset")||(n.byterange.offset=r?b:0,r&&(b=n.byterange.offset+n.byterange.length)));var i=o.preloadHints.length-1;if(this.warnOnMissingAttributes_("#EXT-X-PRELOAD-HINT #"+i+" for segment #"+t,e.attributes,["TYPE","URI"]),n.type)for(var s=0;s<o.preloadHints.length-1;s++){var a=o.preloadHints[s];a.type&&a.type===n.type&&this.trigger("warn",{message:"#EXT-X-PRELOAD-HINT #"+i+" for segment #"+t+" has the same TYPE "+n.type+" as preload hint #"+s})}},"rendition-report":function(){var t=h(e.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(t);var n=this.manifest.renditionReports.length-1,r=["LAST-MSN","URI"];u&&r.push("LAST-PART"),this.warnOnMissingAttributes_("#EXT-X-RENDITION-REPORT #"+n,e.attributes,r)},"part-inf":function(){this.manifest.partInf=h(e.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",e.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),y.call(this,this.manifest)}}[e.tagType]||d).call(i)},uri:function(){o.uri=e.uri,s.push(o),this.manifest.targetDuration&&!("duration"in o)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),o.duration=this.manifest.targetDuration),r&&(o.key=r),o.timeline=m,n&&(o.map=n),b=0,o={}},comment:function(){},custom:function(){e.segment?(o.custom=o.custom||{},o.custom[e.customType]=e.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[e.customType]=e.data)}})[e.type].call(i)})),t}i(t,e);var n=t.prototype;return n.warnOnMissingAttributes_=function(e,t,n){var r=[];n.forEach((function(e){t.hasOwnProperty(e)||r.push(e)})),r.length&&this.trigger("warn",{message:e+" lacks required attribute(s): "+r.join(", ")})},n.push=function(e){this.lineStream.push(e)},n.end=function(){this.lineStream.push("\n"),this.trigger("end")},n.addParser=function(e){this.parseStream.addParser(e)},n.addTagMapper=function(e){this.parseStream.addTagMapper(e)},t}(s)},1046:function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BandwidthApproximator=void 0;const o=(0,a(n(7642)).default)("p2pml:bandwidth-approximator"),u=2e3;let d=i((function e(t,n){s(this,e),this.value=t,this.timeStamp=n}));t.BandwidthApproximator=i((function e(){s(this,e),this.lastBytes=[],this.currentBytesSum=0,this.lastBandwidth=[],this.addBytes=(e,t)=>{for(o("Add %d bytes.",e),this.lastBytes.push(new d(e,t)),this.currentBytesSum+=e;t-this.lastBytes[0].timeStamp>u;)this.currentBytesSum-=this.lastBytes.shift().value;const n=Math.min(u,t);this.lastBandwidth.push(new d(this.currentBytesSum/n,t))},this.getBandwidth=e=>{for(;0!==this.lastBandwidth.length&&e-this.lastBandwidth[0].timeStamp>4e4;)this.lastBandwidth.shift();let t=0;for(const n of this.lastBandwidth)n.value>t&&(t=n.value);return o("Max bandwidth: %d.",t),t},this.getSmoothInterval=()=>u,this.getMeasureInterval=()=>4e4}))},1927:function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&o(e,t)}function o(e,t){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},o(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=l(e);if(t){var i=l(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return d(this,n)}}function d(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}var g=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HttpMediaManager=void 0;const c=g(n(7642));let m=function(e){a(n,e);var t=u(n);function n(){return s(this,n),t.apply(this,arguments)}return i(n)}(n(1351).STEEmitter),p=function(e){a(n,e);var t=u(n);function n(e){var r;return s(this,n),(r=t.call(this)).settings=e,r.fetchRequests=new Map,r.failedSegments=new Map,r.fetch=function(){return fetch.apply(void 0,arguments)},r.debug=(0,c.default)("p2pml:http-media-manager"),r.download=(e,t)=>{if(r.isDownloading(e))return;r.cleanTimedOutFailedSegments(),r.emit("segment-start-load",e);const n=e.priority<=r.settings.skipSegmentBuilderPriority?e.url:r.buildSegmentUrl(e);r.debug("http segment download",n),e.requestUrl=n;const i=new AbortController,s=i.signal,a=new Headers;if(e.range)a.append("Range",e.range),t=void 0;else if(void 0!==t&&r.settings.httpUseRanges){let e=0;for(const n of t)e+=n.byteLength;a.append("Range","bytes=".concat(e,"-")),r.debug("continue download from",e)}else t=void 0;const o=r.fetch(n,{headers:a,signal:s});r.setupFetchEvents(o,e,t).catch((t=>{if("AbortError"!==t.name)if("network error"!==t.message)if("Failed to fetch"!==t.message);else{r.debug("Segment fetch failed",e);const t=Error("FETCH_FAILED");r.segmentFailure(e,t,e.url)}else{r.debug("Segment loading is unavailable. No internet",e);const t=Error("NETWORK_ERROR");r.segmentFailure(e,t,e.url)}else r.debug("Segment loading was aborted by user",e)})),r.fetchRequests.set(e.id,{fetchAbort:i,segment:e,initialPriority:e.priority,segmentUrl:n})},r.updatePriority=e=>{const t=r.fetchRequests.get(e.id);if(!t)throw new Error("Cannot update priority of not downloaded segment "+e.id);e.priority<=r.settings.requiredSegmentsPriority&&t.initialPriority>r.settings.requiredSegmentsPriority&&t.segmentUrl!==r.buildSegmentUrl(e)&&(r.debug("aborting http segment abort because the segment is now in a high priority",e.id),r.abort(e),r.download(e))},r.abort=e=>{const t=r.fetchRequests.get(e.id);t&&(t.fetchAbort.abort(),r.fetchRequests.delete(e.id),r.debug("http segment abort",e.id))},r.isDownloading=e=>r.fetchRequests.has(e.id),r.isFailed=e=>{const t=r.failedSegments.get(e.id);return void 0!==t&&t>r.now()},r.getActiveDownloads=()=>r.fetchRequests,r.getActiveDownloadsCount=()=>r.fetchRequests.size,r.destroy=()=>{r.fetchRequests.forEach((e=>e.fetchAbort.abort())),r.fetchRequests.clear()},r.setupFetchEvents=async(e,t,n)=>{const i=await e,s=i.body.getReader(),a=i.headers.get("Content-Length"),o=Number.parseFloat(a),u=new Uint8Array(o);let d,l=0;if(Array.isArray(n)&&206===i.status)for(const r of n){const e=new Uint8Array(r);u.set(e,l),l=r.byteLength}for(;!(d=await s.read()).done;){const e=d.value;u.set(e,l),l+=e.length,r.emit("bytes-downloaded",t,e.length),o&&r.emit("segment-size",t,o)}if(i.status<200||i.status>=300){const e=Error("Segment failure with HTTP code ".concat(i.status));r.segmentFailure(t,e,i.url)}else await r.segmentDownloadFinished(t,u.buffer,i)},r.segmentDownloadFinished=async(e,t,n)=>{if(e.responseUrl=n.url,r.settings.segmentValidator)try{await r.settings.segmentValidator(Object.assign(Object.assign({},e),{data:t}),"http")}catch(i){return r.debug("segment validator failed",i),void r.segmentFailure(e,i,n.url)}r.fetchRequests.delete(e.id),r.emit("segment-loaded",e,t)},r.segmentFailure=(e,t,n)=>{e.responseUrl=n,r.fetchRequests.delete(e.id),r.failedSegments.set(e.id,r.now()+r.settings.httpFailedSegmentTimeout),r.emit("segment-error",e,t)},r.cleanTimedOutFailedSegments=()=>{const e=r.now(),t=[];r.failedSegments.forEach(((n,r)=>{n<e&&t.push(r)})),t.forEach((e=>r.failedSegments.delete(e)))},r.now=()=>performance.now(),e.localTransport&&(r.fetch=e.localTransport),r}return i(n,[{key:"buildSegmentUrl",value:function(e){return this.settings.segmentUrlBuilder?this.settings.segmentUrlBuilder(e):e.url}}]),n}(m);t.HttpMediaManager=p},8503:function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},i(e,t)}function s(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HybridLoader=void 0;const u=o(n(7642)),d=n(4575),l=o(n(5151)),g=n(1263),c=n(1927),m=n(9208),p=n(4811),f=n(1046),h=n(8656),y={cachedSegmentExpiration:3e5,cachedSegmentsCount:30,useP2P:!0,consumeOnly:!1,requiredSegmentsPriority:1,skipSegmentBuilderPriority:1,simultaneousHttpDownloads:2,httpDownloadProbability:.1,httpDownloadProbabilityInterval:1e3,httpDownloadProbabilitySkipIfNoPeers:!1,httpFailedSegmentTimeout:1e4,httpDownloadMaxPriority:20,httpDownloadInitialTimeout:0,httpDownloadInitialTimeoutPerSegment:4e3,httpUseRanges:!1,simultaneousP2PDownloads:3,p2pDownloadMaxPriority:20,p2pSegmentDownloadTimeout:6e4,webRtcMaxMessageSize:65535,trackerAnnounce:["wss://tracker.novage.com.ua","wss://tracker.openwebtorrent.com"],peerRequestsPerAnnounce:10,rtcConfig:l.default.config};let b=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&i(e,t)}(l,e);var t,n,o,d=(n=l,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=a(n);if(o){var r=a(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return s(this,e)});function l(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,l),(e=d.call(this)).debug=(0,u.default)("p2pml:hybrid-loader"),e.debugSegments=(0,u.default)("p2pml:hybrid-loader-segments"),e.segmentsQueue=[],e.bandwidthApproximator=new f.BandwidthApproximator,e.httpDownloadInitialTimeoutTimestamp=-1/0,e.createHttpManager=()=>new c.HttpMediaManager(e.settings),e.createP2PManager=()=>new m.P2PMediaManager(e.segmentsStorage,e.settings),e.load=async(t,n)=>{e.initRandomDownloadIntervalIfNeeded(),t.length>0&&(e.masterSwarmId=t[0].masterSwarmId),void 0!==e.masterSwarmId&&e.p2pManager.setStreamSwarmId(n,e.masterSwarmId),e.debug("load segments");let r=e.abortUnknownSegments(t);if(e.debug.enabled)for(const s of t)e.segmentsQueue.find((e=>e.id===s.id))||e.debug("add segment",s.id);if(e.segmentsQueue=t,void 0===e.masterSwarmId)return;let i=await e.segmentsStorage.getSegmentsMap(e.masterSwarmId);r=e.processSegmentsQueue(i)||r,await e.cleanSegmentsStorage()&&(i=await e.segmentsStorage.getSegmentsMap(e.masterSwarmId),r=!0),r&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(i))},e.getSegment=async t=>void 0===e.masterSwarmId?void 0:e.segmentsStorage.getSegment(t,e.masterSwarmId),e.getSettings=()=>e.settings,e.getDetails=()=>({peerId:e.p2pManager.getPeerId()}),e.getBandwidthEstimate=()=>e.bandwidthApproximator.getBandwidth(e.now()),e.destroy=async()=>{void 0!==e.httpRandomDownloadInterval&&(clearInterval(e.httpRandomDownloadInterval),e.httpRandomDownloadInterval=void 0),e.httpDownloadInitialTimeoutTimestamp=-1/0,e.segmentsQueue=[],e.httpManager.destroy(),e.p2pManager.destroy(),e.masterSwarmId=void 0,await e.segmentsStorage.destroy()},e.processInitialSegmentTimeout=async()=>{if(void 0!==e.httpRandomDownloadInterval){if(void 0!==e.masterSwarmId){const t=await e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(t)&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(t))}e.httpDownloadInitialTimeoutTimestamp!==-1/0&&setTimeout(e.processInitialSegmentTimeout,e.settings.httpDownloadInitialTimeoutPerSegment)}},e.processSegmentsQueue=t=>{if(e.debugSegments("process segments queue. priority: ".concat(e.segmentsQueue.length>0?e.segmentsQueue[0].priority:0,", queue length: ").concat(e.segmentsQueue.length)),void 0===e.masterSwarmId||0===e.segmentsQueue.length)return!1;let n,r=!1,i=!0;if(e.httpDownloadInitialTimeoutTimestamp!==-1/0){let n;for(const i of e.segmentsQueue)if(!t.has(i.id)){n=i.priority;break}const r=e.now()-e.httpDownloadInitialTimeoutTimestamp;i=r>=e.settings.httpDownloadInitialTimeout||void 0!==n&&r>e.settings.httpDownloadInitialTimeoutPerSegment&&n<=0,i&&(e.debugSegments("cancel initial HTTP download timeout - timed out"),e.httpDownloadInitialTimeoutTimestamp=-1/0)}let s=!1;for(let a=0;a<e.segmentsQueue.length;a++){const o=e.segmentsQueue[a];if(t.has(o.id))continue;if(e.httpManager.isDownloading(o)){e.httpManager.updatePriority(o);continue}const u=i&&o.priority<=e.settings.requiredSegmentsPriority;if(u&&!e.httpManager.isFailed(o)){if(e.httpManager.getActiveDownloadsCount()>=e.settings.simultaneousHttpDownloads)for(let t=e.segmentsQueue.length-1;t>a;t--){const n=e.segmentsQueue[t];if(e.httpManager.isDownloading(n)){e.debugSegments("cancel HTTP download",n.priority,n.id),e.httpManager.abort(n);break}}if(e.httpManager.getActiveDownloadsCount()<e.settings.simultaneousHttpDownloads){const t=e.p2pManager.abort(o);e.httpManager.download(o,t),e.debugSegments("HTTP download (priority)",o.priority,o.id),r=!0;continue}}if(u&&e.httpManager.isFailed(o)&&(s=!0),!e.p2pManager.isDownloading(o))if(o.priority<=e.settings.requiredSegmentsPriority){if(n=n||e.p2pManager.getOverallSegmentsMap(),n.get(o.id)!==p.MediaPeerSegmentStatus.Loaded)continue;if(e.p2pManager.getActiveDownloadsCount()>=e.settings.simultaneousP2PDownloads)for(let t=e.segmentsQueue.length-1;t>a;t--){const n=e.segmentsQueue[t];if(e.p2pManager.isDownloading(n)){e.debugSegments("cancel P2P download",n.priority,n.id),e.p2pManager.abort(n);break}}if(e.p2pManager.getActiveDownloadsCount()<e.settings.simultaneousP2PDownloads&&e.p2pManager.download(o)){e.debugSegments("P2P download (priority)",o.priority,o.id);continue}}else e.p2pManager.getActiveDownloadsCount()<e.settings.simultaneousP2PDownloads&&o.priority<=e.settings.p2pDownloadMaxPriority&&e.p2pManager.download(o)&&e.debugSegments("P2P download",o.priority,o.id)}return s&&setTimeout((async()=>{if(void 0===e.masterSwarmId)return;const t=await e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(t)}),e.settings.httpFailedSegmentTimeout),r},e.downloadRandomSegmentOverHttp=async()=>{if(void 0===e.masterSwarmId||void 0===e.httpRandomDownloadInterval||e.httpDownloadInitialTimeoutTimestamp!==-1/0||e.httpManager.getActiveDownloadsCount()>=e.settings.simultaneousHttpDownloads||e.settings.httpDownloadProbabilitySkipIfNoPeers&&0===e.p2pManager.getPeers().size||e.settings.consumeOnly)return;const t=await e.segmentsStorage.getSegmentsMap(e.masterSwarmId),n=e.p2pManager.getOverallSegmentsMap(),r=e.segmentsQueue.filter((r=>!e.p2pManager.isDownloading(r)&&!e.httpManager.isDownloading(r)&&!n.has(r.id)&&!e.httpManager.isFailed(r)&&r.priority<=e.settings.httpDownloadMaxPriority&&!t.has(r.id)));if(0===r.length)return;if(Math.random()>e.settings.httpDownloadProbability*r.length)return;const i=r[Math.floor(Math.random()*r.length)];e.debugSegments("HTTP download (random)",i.priority,i.id),e.httpManager.download(i),e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(t))},e.onSegmentStartLoad=(t,n)=>{e.emit(g.Events.SegmentStartLoad,t,n)},e.onPieceBytesDownloaded=(t,n,r,i)=>{e.bandwidthApproximator.addBytes(r,e.now()),e.emit(g.Events.PieceBytesDownloaded,t,n,r,i)},e.onPieceBytesUploaded=(t,n,r,i)=>{e.emit(g.Events.PieceBytesUploaded,t,n,r,i)},e.onSegmentLoaded=async(t,n,r)=>{if(e.debugSegments("segment loaded",t.id,t.id),void 0===e.masterSwarmId)return;t.data=n,t.downloadBandwidth=e.bandwidthApproximator.getBandwidth(e.now()),await e.segmentsStorage.storeSegment(t),e.emit(g.Events.SegmentLoaded,t,r);const i=await e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(i),e.settings.consumeOnly||e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(i))},e.onSegmentError=async(t,n,r)=>{if(e.debugSegments("segment error",t.id,t.id,r,n),e.emit(g.Events.SegmentError,t,n,r),void 0!==e.masterSwarmId){const t=await e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(t)&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(t))}},e.onSegmentSize=async(t,n)=>{e.debugSegments("segment size",t.id,n),e.emit(g.Events.SegmentSize,t,n)},e.getStreamSwarmId=e=>void 0===e.streamId?e.masterSwarmId:"".concat(e.masterSwarmId,"+").concat(e.streamId),e.createSegmentsMap=t=>{const n={},r=(t,r)=>{const i=e.getStreamSwarmId(t),s=t.sequence;let a=n[i];void 0===a&&(a=["",[]],n[i]=a);const o=a[1];a[0]+=0===o.length?s:"|".concat(s),o.push(r)};for(const e of t.values())r(e.segment,p.MediaPeerSegmentStatus.Loaded);for(const i of e.httpManager.getActiveDownloads().values())r(i.segment,p.MediaPeerSegmentStatus.LoadingByHttp);return n},e.onPeerConnect=async t=>{e.emit(g.Events.PeerConnect,t),e.settings.consumeOnly||void 0===e.masterSwarmId||e.p2pManager.sendSegmentsMap(t.id,e.createSegmentsMap(await e.segmentsStorage.getSegmentsMap(e.masterSwarmId)))},e.onPeerClose=t=>{e.emit(g.Events.PeerClose,t)},e.onTrackerUpdate=async t=>{if(e.httpDownloadInitialTimeoutTimestamp!==-1/0&&void 0!==t.incomplete&&t.incomplete<=1&&(e.debugSegments("cancel initial HTTP download timeout - no peers"),e.httpDownloadInitialTimeoutTimestamp=-1/0,void 0!==e.masterSwarmId)){const t=await e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(t)&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(t))}},e.cleanSegmentsStorage=async()=>void 0!==e.masterSwarmId&&e.segmentsStorage.clean(e.masterSwarmId,(t=>void 0!==e.segmentsQueue.find((e=>e.id===t)))),e.now=()=>performance.now(),e.initRandomDownloadIntervalIfNeeded=()=>{void 0===e.httpRandomDownloadInterval&&(e.httpRandomDownloadInterval=setInterval(e.downloadRandomSegmentOverHttp,e.settings.httpDownloadProbabilityInterval),e.settings.httpDownloadInitialTimeout>0&&e.settings.httpDownloadInitialTimeoutPerSegment>0&&(e.debugSegments("enable initial HTTP download timeout",e.settings.httpDownloadInitialTimeout,"per segment",e.settings.httpDownloadInitialTimeoutPerSegment),e.httpDownloadInitialTimeoutTimestamp=e.now(),setTimeout(e.processInitialSegmentTimeout,e.settings.httpDownloadInitialTimeoutPerSegment+100)))},e.abortUnknownSegments=t=>{let n=!1;for(const r of e.segmentsQueue)t.find((e=>e.id===r.id))||(e.debug("remove segment",r.id),e.httpManager.isDownloading(r)?(n=!0,e.httpManager.abort(r)):e.p2pManager.abort(r),e.emit(g.Events.SegmentAbort,r));return n},e.settings=Object.assign(Object.assign({},y),t);const{bufferedSegmentsCount:n}=t;return"number"==typeof n&&(void 0===t.p2pDownloadMaxPriority&&(e.settings.p2pDownloadMaxPriority=n),void 0===t.httpDownloadMaxPriority&&(e.settings.p2pDownloadMaxPriority=n)),e.segmentsStorage=void 0===e.settings.segmentsStorage?new h.SegmentsMemoryStorage(e.settings):e.settings.segmentsStorage,e.debug("loader settings",e.settings),e.httpManager=e.createHttpManager(),e.httpManager.on("segment-start-load",(t=>e.onSegmentStartLoad("http",t))),e.httpManager.on("segment-loaded",e.onSegmentLoaded),e.httpManager.on("segment-error",e.onSegmentError),e.httpManager.on("segment-size",e.onSegmentSize),e.httpManager.on("bytes-downloaded",((t,n)=>{e.onPieceBytesDownloaded("http",t,n)})),e.p2pManager=e.createP2PManager(),e.p2pManager.on("segment-start-load",(t=>e.onSegmentStartLoad("p2p",t))),e.p2pManager.on("segment-loaded",e.onSegmentLoaded),e.p2pManager.on("segment-error",e.onSegmentError),e.p2pManager.on("segment-size",e.onSegmentSize),e.p2pManager.on("peer-data-updated",(async()=>{if(void 0===e.masterSwarmId)return;const t=await e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(t)&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(t))})),e.p2pManager.on("bytes-downloaded",((t,n,r)=>e.onPieceBytesDownloaded("p2p",t,n,r))),e.p2pManager.on("bytes-uploaded",((t,n,r)=>e.onPieceBytesUploaded("p2p",t,n,r))),e.p2pManager.on("peer-connected",e.onPeerConnect),e.p2pManager.on("peer-closed",e.onPeerClose),e.p2pManager.on("tracker-update",e.onTrackerUpdate),e}return t=l,Object.defineProperty(t,"prototype",{writable:!1}),t}(d.EventEmitter);t.HybridLoader=b,b.isSupported=()=>void 0!==window.RTCPeerConnection.prototype.createDataChannel},7382:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.version=void 0,t.version="0.6.2",i(n(1263),t),i(n(8503),t)},1263:(e,t)=>{"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.Events=void 0,(n=t.Events||(t.Events={})).SegmentLoaded="segment_loaded",n.SegmentError="segment_error",n.SegmentSize="segment_size",n.SegmentAbort="segment_abort",n.SegmentStartLoad="segment_start_load",n.PeerConnect="peer_connect",n.PeerClose="peer_close",n.PieceBytesDownloaded="piece_bytes_downloaded",n.PieceBytesUploaded="piece_bytes_uploaded"},4811:function(e,t,n){"use strict";function r(e,t){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},r(e,t)}function i(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return s(e)}function s(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function d(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MediaPeer=t.MediaPeerSegmentStatus=void 0;const g=l(n(7642)),c=n(2236),m=n(1351);var p,f;!function(e){e[e.SegmentData=0]="SegmentData",e[e.SegmentAbsent=1]="SegmentAbsent",e[e.SegmentsMap=2]="SegmentsMap",e[e.SegmentRequest=3]="SegmentRequest",e[e.CancelSegmentRequest=4]="CancelSegmentRequest"}(p||(p={})),function(e){e[e.Loaded=0]="Loaded",e[e.LoadingByHttp=1]="LoadingByHttp"}(f=t.MediaPeerSegmentStatus||(t.MediaPeerSegmentStatus={}));let h=u((function e(t,n){d(this,e),this.id=t,this.size=n,this.bytesDownloaded=0,this.pieces=[]}));t.MediaPeer=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&r(e,t)}(l,e);var t,n,o=(t=l,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=a(t);if(n){var s=a(this).constructor;e=Reflect.construct(r,arguments,s)}else e=r.apply(this,arguments);return i(this,e)});function l(e,t){var n;return d(this,l),(n=o.call(this)).peer=e,n.settings=t,n.remoteAddress="",n.downloadingSegmentId=null,n.downloadingSegment=null,n.segmentsMap=new Map,n.debug=(0,g.default)("p2pml:media-peer"),n.timer=null,n.onPeerConnect=()=>{n.debug("peer connect",n.id,s(n)),n.remoteAddress=n.peer.remoteAddress,n.emit("connect",s(n))},n.onPeerClose=()=>{n.debug("peer close",n.id,s(n)),n.terminateSegmentRequest(),n.emit("close",s(n))},n.onPeerError=e=>{n.debug("peer error",n.id,e,s(n))},n.receiveSegmentPiece=e=>{if(!n.downloadingSegment)return void n.debug("peer segment not requested",n.id,s(n));n.downloadingSegment.bytesDownloaded+=e.byteLength,n.downloadingSegment.pieces.push(e);const t=n.downloadingSegment.id;if(n.emit("bytes-downloaded",s(n),t,e.byteLength),n.downloadingSegment.bytesDownloaded===n.downloadingSegment.size){const e=new Uint8Array(n.downloadingSegment.size);let r=0;for(const t of n.downloadingSegment.pieces)e.set(new Uint8Array(t),r),r+=t.byteLength;n.debug("peer segment download done",n.id,t,s(n)),n.terminateSegmentRequest(),n.emit("segment-loaded",s(n),t,e.buffer)}else n.downloadingSegment.bytesDownloaded>n.downloadingSegment.size&&(n.debug("peer segment download bytes mismatch",n.id,t,s(n)),n.terminateSegmentRequest(),n.emit("segment-error",s(n),t,"Too many bytes received for segment"))},n.getJsonCommand=e=>{const t=new Uint8Array(e);if(123===t[0]&&34===t[1]&&125===t[e.byteLength-1])try{return JSON.parse((new TextDecoder).decode(e))}catch(n){return null}return null},n.onPeerData=e=>{const t=n.getJsonCommand(e);if(null!==t){if(n.downloadingSegment){n.debug("peer segment download is interrupted by a command",n.id,s(n));const e=n.downloadingSegment.id;return n.terminateSegmentRequest(),void n.emit("segment-error",s(n),e,"Segment download is interrupted by a command")}switch(n.debug("peer receive command",n.id,t,s(n)),t.c){case p.SegmentsMap:n.segmentsMap=n.createSegmentsMap(t.m),n.emit("data-updated");break;case p.SegmentRequest:n.emit("segment-request",s(n),t.i);break;case p.SegmentData:n.downloadingSegmentId&&n.downloadingSegmentId===t.i&&"number"==typeof t.s&&t.s>=0&&(n.downloadingSegment=new h(t.i,t.s),n.emit("segment-start-load",n.downloadingSegment.id),n.emit("segment-size",n.downloadingSegment.id,n.downloadingSegment.size),n.cancelResponseTimeoutTimer());break;case p.SegmentAbsent:n.downloadingSegmentId&&n.downloadingSegmentId===t.i&&(n.terminateSegmentRequest(),n.segmentsMap.delete(t.i),n.emit("segment-absent",s(n),t.i))}}else n.receiveSegmentPiece(e)},n.createSegmentsMap=e=>{if(!(e instanceof Object))return new Map;const t=new Map;for(const n of Object.keys(e)){const r=e[n];if(!(r instanceof Array&&2===r.length&&"string"==typeof r[0]&&r[1]instanceof Array))return new Map;const i=r[0].split("|"),s=r[1];if(i.length!==s.length)return new Map;for(let e=0;e<i.length;e++){const r=s[e];if("number"!=typeof r||void 0===f[r])return new Map;t.set("".concat(n,"+").concat(i[e]),r)}}return t},n.sendCommand=e=>{n.debug("peer send command",n.id,e,s(n)),n.peer.write(JSON.stringify(e))},n.destroy=()=>{n.debug("peer destroy",n.id,s(n)),n.terminateSegmentRequest(),n.peer.destroy()},n.getDownloadingSegmentId=()=>n.downloadingSegmentId,n.getSegmentsMap=()=>n.segmentsMap,n.sendSegmentsMap=e=>{n.sendCommand({c:p.SegmentsMap,m:e})},n.sendSegmentData=(e,t)=>{n.sendCommand({c:p.SegmentData,i:e,s:t.byteLength});let r=t.byteLength;for(;r>0;){const e=r>=n.settings.webRtcMaxMessageSize?n.settings.webRtcMaxMessageSize:r,i=c.Buffer.from(t,t.byteLength-r,e);n.peer.write(i),r-=e}n.emit("bytes-uploaded",s(n),e,t.byteLength)},n.sendSegmentAbsent=e=>{n.sendCommand({c:p.SegmentAbsent,i:e})},n.requestSegment=e=>{if(n.downloadingSegmentId)throw new Error("A segment is already downloading: "+n.downloadingSegmentId);n.sendCommand({c:p.SegmentRequest,i:e}),n.downloadingSegmentId=e,n.runResponseTimeoutTimer()},n.cancelSegmentRequest=()=>{let e;if(n.downloadingSegmentId){const t=n.downloadingSegmentId;e=n.downloadingSegment?n.downloadingSegment.pieces:void 0,n.terminateSegmentRequest(),n.sendCommand({c:p.CancelSegmentRequest,i:t})}return e},n.runResponseTimeoutTimer=()=>{n.timer=setTimeout((()=>{if(n.timer=null,!n.downloadingSegmentId)return;const e=n.downloadingSegmentId;n.cancelSegmentRequest(),n.emit("segment-timeout",s(n),e)}),n.settings.p2pSegmentDownloadTimeout)},n.cancelResponseTimeoutTimer=()=>{n.timer&&(clearTimeout(n.timer),n.timer=null)},n.terminateSegmentRequest=()=>{n.downloadingSegmentId=null,n.downloadingSegment=null,n.cancelResponseTimeoutTimer()},n.peer.on("connect",n.onPeerConnect),n.peer.on("close",n.onPeerClose),n.peer.on("error",n.onPeerError),n.peer.on("data",n.onPeerData),n.id=e.id,n}return u(l)}(m.STEEmitter)},9208:function(e,t,n){"use strict";function r(e,t){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},r(e,t)}function i(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var d=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.P2PMediaManager=void 0;const l=d(n(7642)),g=d(n(5731)),c=n(2236),m=d(n(599)),p=n(1351),f=n(4811),h=n(7382).version.replace(/\d*./g,(e=>"0".concat(parseInt(e,10)%100).slice(-2))).slice(0,4),y="-WW".concat(h,"-");let b=o((function e(t,n){u(this,e),this.peerId=t,this.segment=n})),S=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&r(e,t)}(d,e);var t,n,a=(t=d,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=s(t);if(n){var a=s(this).constructor;e=Reflect.construct(r,arguments,a)}else e=r.apply(this,arguments);return i(this,e)});function d(e,t){var n;return u(this,d),(n=a.call(this)).segmentsStorage=e,n.settings=t,n.trackerClient=null,n.peers=new Map,n.peerCandidates=new Map,n.peerSegmentRequests=new Map,n.streamSwarmId=null,n.debug=(0,l.default)("p2pml:p2p-media-manager"),n.pendingTrackerClient=null,n.getPeers=()=>n.peers,n.getPeerId=()=>c.Buffer.from(n.peerId).toString("hex"),n.setStreamSwarmId=(e,t)=>{if(n.streamSwarmId===e)return;n.destroy(!0),n.streamSwarmId=e,n.masterSwarmId=t,n.debug("stream swarm ID",n.streamSwarmId),n.pendingTrackerClient={isDestroyed:!1};const r=n.pendingTrackerClient,i=(new m.default).update("".concat(2).concat(n.streamSwarmId)).digest();r.isDestroyed?null!==n.trackerClient&&(n.trackerClient.destroy(),n.trackerClient=null):(n.pendingTrackerClient=null,n.createClient(i))},n.createClient=e=>{if(!n.settings.useP2P)return;const t={infoHash:c.Buffer.from(e,0,20),peerId:c.Buffer.from(n.peerId,0,20),announce:n.settings.trackerAnnounce,rtcConfig:n.settings.rtcConfig,port:6881,getAnnounceOpts:()=>({numwant:n.settings.peerRequestsPerAnnounce})};let r=n.trackerClient;n.trackerClient=new g.default(t),n.trackerClient.on("error",n.onTrackerError),n.trackerClient.on("warning",n.onTrackerWarning),n.trackerClient.on("update",n.onTrackerUpdate),n.trackerClient.on("peer",n.onTrackerPeer),n.trackerClient.start(),null!==r&&(r.destroy(),r=null)},n.onTrackerError=e=>{n.debug("tracker error",e)},n.onTrackerWarning=e=>{n.debug("tracker warning",e)},n.onTrackerUpdate=e=>{n.debug("tracker update",e),n.emit("tracker-update",e)},n.onTrackerPeer=e=>{if(n.debug("tracker peer",e.id,e),n.peers.has(e.id))return n.debug("tracker peer already connected",e.id,e),void e.destroy();const t=new f.MediaPeer(e,n.settings);t.on("connect",n.onPeerConnect),t.on("close",n.onPeerClose),t.on("data-updated",n.onPeerDataUpdated),t.on("segment-request",n.onSegmentRequest),t.on("segment-loaded",n.onSegmentLoaded),t.on("segment-absent",n.onSegmentAbsent),t.on("segment-error",n.onSegmentError),t.on("segment-size",n.onSegmentSize),t.on("segment-start-load",n.onSegmentStartLoad),t.on("segment-timeout",n.onSegmentTimeout),t.on("bytes-downloaded",n.onPieceBytesDownloaded),t.on("bytes-uploaded",n.onPieceBytesUploaded);let r=n.peerCandidates.get(t.id);r||(r=[],n.peerCandidates.set(t.id,r)),r.push(t)},n.download=e=>{if(n.isDownloading(e))return!1;const t=[];for(const i of n.peers.values())null===i.getDownloadingSegmentId()&&i.getSegmentsMap().get(e.id)===f.MediaPeerSegmentStatus.Loaded&&t.push(i);if(0===t.length)return!1;const r=t[Math.floor(Math.random()*t.length)];return r.requestSegment(e.id),n.peerSegmentRequests.set(e.id,new b(r.id,e)),!0},n.abort=e=>{let t;const r=n.peerSegmentRequests.get(e.id);if(r){const i=n.peers.get(r.peerId);i&&(t=i.cancelSegmentRequest()),n.peerSegmentRequests.delete(e.id)}return t},n.isDownloading=e=>n.peerSegmentRequests.has(e.id),n.getActiveDownloadsCount=()=>n.peerSegmentRequests.size,n.destroy=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];n.streamSwarmId=null,n.trackerClient&&(n.trackerClient.stop(),e?(n.trackerClient.removeAllListeners("error"),n.trackerClient.removeAllListeners("warning"),n.trackerClient.removeAllListeners("update"),n.trackerClient.removeAllListeners("peer")):(n.trackerClient.destroy(),n.trackerClient=null)),n.pendingTrackerClient&&(n.pendingTrackerClient.isDestroyed=!0,n.pendingTrackerClient=null),n.peers.forEach((e=>e.destroy())),n.peers.clear(),n.peerSegmentRequests.clear();for(const t of n.peerCandidates.values())for(const e of t)e.destroy();n.peerCandidates.clear()},n.sendSegmentsMapToAll=e=>{n.peers.forEach((t=>t.sendSegmentsMap(e)))},n.sendSegmentsMap=(e,t)=>{const r=n.peers.get(e);r&&r.sendSegmentsMap(t)},n.getOverallSegmentsMap=()=>{const e=new Map;for(const t of n.peers.values())for(const[n,r]of t.getSegmentsMap())r===f.MediaPeerSegmentStatus.Loaded?e.set(n,f.MediaPeerSegmentStatus.Loaded):e.get(n)||e.set(n,f.MediaPeerSegmentStatus.LoadingByHttp);return e},n.onPieceBytesDownloaded=(e,t,r)=>{const i=n.peerSegmentRequests.get(t);i&&n.emit("bytes-downloaded",i.segment,r,e.id)},n.onPieceBytesUploaded=async(e,t,r)=>{if(void 0===n.masterSwarmId)return;const i=await n.segmentsStorage.getSegment(t,n.masterSwarmId);i&&n.emit("bytes-uploaded",i,r,e.id)},n.onPeerConnect=e=>{if(n.peers.get(e.id))return n.debug("tracker peer already connected (in peer connect)",e.id,e),void e.destroy();n.peers.set(e.id,e);const t=n.peerCandidates.get(e.id);if(t){for(const n of t)n!==e&&n.destroy();n.peerCandidates.delete(e.id)}n.emit("peer-connected",{id:e.id,remoteAddress:e.remoteAddress})},n.onPeerClose=e=>{if(n.peers.get(e.id)!==e){const t=n.peerCandidates.get(e.id);if(!t)return;const r=t.indexOf(e);return-1!==r&&t.splice(r,1),void(0===t.length&&n.peerCandidates.delete(e.id))}for(const[t,r]of n.peerSegmentRequests)r.peerId===e.id&&n.peerSegmentRequests.delete(t);n.peers.delete(e.id),n.emit("peer-data-updated"),n.emit("peer-closed",e.id)},n.onPeerDataUpdated=()=>{n.emit("peer-data-updated")},n.onSegmentRequest=async(e,t)=>{if(void 0===n.masterSwarmId)return;const r=await n.segmentsStorage.getSegment(t,n.masterSwarmId);r&&r.data?e.sendSegmentData(t,r.data):e.sendSegmentAbsent(t)},n.onSegmentLoaded=async(e,t,r)=>{const i=n.peerSegmentRequests.get(t);if(!i)return;const s=i.segment;if(n.settings.segmentValidator)try{await n.settings.segmentValidator(Object.assign(Object.assign({},s),{data:r}),"p2p",e.id)}catch(a){return n.debug("segment validator failed",a),n.peerSegmentRequests.delete(t),n.emit("segment-error",s,a,e.id),void n.onPeerClose(e)}n.peerSegmentRequests.delete(t),n.emit("segment-loaded",s,r,e.id)},n.onSegmentAbsent=(e,t)=>{n.peerSegmentRequests.delete(t),n.emit("peer-data-updated")},n.onSegmentError=(e,t,r)=>{const i=n.peerSegmentRequests.get(t);i&&(n.peerSegmentRequests.delete(t),n.emit("segment-error",i.segment,r,e.id))},n.onSegmentSize=(e,t)=>{const r=n.peerSegmentRequests.get(e);r&&n.emit("segment-size",r.segment,t)},n.onSegmentStartLoad=(e,t)=>{const r=n.peerSegmentRequests.get(e);r&&n.emit("segment-start-load",r.segment,t)},n.onSegmentTimeout=(e,t)=>{const r=n.peerSegmentRequests.get(t);r&&(n.peerSegmentRequests.delete(t),e.destroy(),n.peers.delete(r.peerId)&&n.emit("peer-data-updated"))},n.peerId=t.useP2P?function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t=y;for(let n=0;n<20-y.length;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return(new TextEncoder).encode(t).buffer}():new ArrayBuffer(0),n.debug.enabled&&n.debug("peer ID",n.getPeerId(),(new TextDecoder).decode(n.peerId)),n}return o(d)}(p.STEEmitter);t.P2PMediaManager=S},8656:(e,t)=>{"use strict";function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentsMemoryStorage=void 0,t.SegmentsMemoryStorage=r((function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.settings=t,this.cache=new Map,this.storeSegment=async e=>{this.cache.set(e.id,{segment:e,lastAccessed:performance.now()})},this.getSegmentsMap=async()=>this.cache,this.getSegment=async e=>{const t=this.cache.get(e);if(void 0!==t)return t.lastAccessed=performance.now(),t.segment},this.hasSegment=async e=>this.cache.has(e),this.clean=async(e,t)=>{const n=[],r=[],i=performance.now();for(const a of this.cache.values())i-a.lastAccessed>this.settings.cachedSegmentExpiration?n.push(a.segment.id):r.push(a);let s=r.length-this.settings.cachedSegmentsCount;if(s>0){r.sort(((e,t)=>e.lastAccessed-t.lastAccessed));for(const e of r)if((void 0===t||!t(e.segment.id))&&(n.push(e.segment.id),s--,0===s))break}return n.forEach((e=>this.cache.delete(e))),n.length>0},this.destroy=async()=>{this.cache.clear()}}))},1351:(e,t,n)=>{"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},i(e,t)}function s(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return a(e)}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function o(){return o="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=u(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},o.apply(this,arguments)}function u(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=d(e)););return e}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.STEEmitter=void 0;const l=n(4575);t.STEEmitter=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&i(e,t)}(g,e);var t,n,u,l=(n=g,u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=d(n);if(u){var r=d(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return s(this,e)});function g(){var e,t,n;return r(this,g),(n=l.apply(this,arguments)).on=(t,r)=>o((e=a(n),d(g.prototype)),"on",e).call(e,t,r),n.emit=function(e){for(var r,i=arguments.length,s=new Array(i>1?i-1:0),u=1;u<i;u++)s[u-1]=arguments[u];return(r=o((t=a(n),d(g.prototype)),"emit",t)).call.apply(r,[t,e].concat(s))},n}return t=g,Object.defineProperty(t,"prototype",{writable:!1}),t}(l.EventEmitter)},701:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.byteRangeToString=t.compareByteRanges=t.getByteRange=void 0,t.getByteRange=function(e){return e.rangeEnd&&void 0!==e.rangeStart?{offset:e.rangeStart,length:e.rangeEnd-e.rangeStart}:void 0},t.compareByteRanges=function(e,t){return void 0===e?void 0===t:void 0!==t&&e.length===t.length&&e.offset===t.offset},t.byteRangeToString=function(e){if(void 0===e)return;const t=e.offset+e.length-1;return"bytes=".concat(e.offset,"-").concat(t)}},9004:(e,t,n)=>{"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e,t){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},a(e,t)}function o(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.Engine=void 0;const d=n(4575),l=n(7382),g=n(7986),c=n(8193);t.Engine=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&a(e,t)}(d,e);var t,n,i=(t=d,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=u(t);if(n){var i=u(this).constructor;e=Reflect.construct(r,arguments,i)}else e=r.apply(this,arguments);return o(this,e)});function d(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,d),(e=i.call(this)).loader=new l.HybridLoader(t.loader),e.segmentManager=new g.SegmentManager(e.loader,t.segments,t.loader),Object.keys(l.Events).map((e=>l.Events[e])).forEach((t=>e.loader.on(t,(function(){for(var n,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(n=e).emit.apply(n,[t].concat(i))})))),e}return s(d,[{key:"createLoaderClass",value:function(){var e;const t=this;return(e=s((function e(){r(this,e),this.load=async(e,t,n)=>{this.context=e,this.callbacks=n,await this.impl.load(e,t,n)},this.abort=()=>{this.context&&this.impl.abort(this.context,this.callbacks)},this.destroy=()=>{this.context&&this.impl.abort(this.context)},this.getResponseHeader=()=>{},this.impl=new c.HlsJsLoader(t.segmentManager),t.setLatestLoaderImpl(this),this.stats=this.impl.stats}))).getEngine=()=>t,e}},{key:"destroy",value:async function(){await this.segmentManager.destroy()}},{key:"abortCurrentRequest",value:function(){this.latestLoaderImpl&&(this.latestLoaderImpl.abort(),this.latestLoaderImpl=void 0)}},{key:"getSettings",value:function(){return{segments:this.segmentManager.getSettings(),loader:this.loader.getSettings()}}},{key:"getDetails",value:function(){return{loader:this.loader.getDetails()}}},{key:"setPlayingSegment",value:function(e,t,n,r){this.segmentManager.setPlayingSegment(e,t,n,r)}},{key:"setPlayingSegmentByCurrentTime",value:function(e){this.segmentManager.setPlayingSegmentByCurrentTime(e)}},{key:"setLatestLoaderImpl",value:function(e){this.latestLoaderImpl=e}}],[{key:"isSupported",value:function(){return l.HybridLoader.isSupported()}}]),d}(d.EventEmitter)},8193:function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HlsJsLoader=void 0;const s=i(n(7642)),a=n(7382),o=n(701);t.HlsJsLoader=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.segmentManager=t,this.debug=(0,s.default)("p2pml:hlsjs-loader"),this.stats={loaded:0,total:0,aborted:!1,retry:0,chunkCount:0,bwEstimate:0,loading:{start:0,end:0,first:0},parsing:{start:0,end:0},buffering:{start:0,end:0,first:0}},this.boundOnSegmentAbort=this.onSegmentAbort.bind(this),this.boundOnUpdateSegmentSize=this.onUpdateSegmentSize.bind(this),this.boundOnUpdateLoaded=this.onUpdateLoaded.bind(this),this.boundOnSegmentStartLoad=this.onSegmentStartLoad.bind(this),this.debugId=""}var t,n,i;return t=e,i=[{key:"updateStatsToStartLoading",value:function(e){if(e.aborted)return;const t=performance.now();e.loading.start=t,e.loading.first=t}}],(n=[{key:"load",value:async function(t,n,r){if(this.context=t,this.callbacks=r,e.updateStatsToStartLoading(this.stats),this.context.type){this.debug("Loading playlist ".concat(this.context.url,"."));try{const e=await this.segmentManager.loadPlaylist(this.context.url);this.debug("Playlist ".concat(this.context.url," loaded.")),this.successPlaylist(e,this.context,this.callbacks)}catch(i){this.error(i,this.context,this.callbacks)}}else if(this.context.frag){this.loader=this.segmentManager.loader,this.byteRange=(0,o.getByteRange)(this.context),this.debugId=this.byteRange?"".concat(this.context.url," / ").concat(this.byteRange.offset):this.context.url,this.debug("Loading fragment ".concat(this.debugId,".")),this.interval=setInterval((()=>e.updateStatsToStartLoading(this.stats)),200),this.loader.on(a.Events.SegmentAbort,this.boundOnSegmentAbort),this.loader.on(a.Events.SegmentSize,this.boundOnUpdateSegmentSize),this.loader.on(a.Events.SegmentStartLoad,this.boundOnSegmentStartLoad);try{const e=await this.segmentManager.loadSegment(this.context.url,this.byteRange),{content:t}=e;t?(this.successSegment(t,this.context,this.callbacks),this.debug("Loaded fragment ".concat(this.debugId,"."))):(this.cleanup(),this.debug("Loaded empty fragment ".concat(this.debugId," (aborted?).")))}catch(i){setTimeout((()=>this.error(i,this.context,this.callbacks)),0),this.debug("Error in fragment ".concat(this.debugId," loading."),i)}}else console.warn("Unknown load request",this.context)}},{key:"abort",value:function(e,t){if(this.stats.loaded||this.stats.aborted)return;this.debug("Aborting by hls.js fragment ".concat(this.debugId," loading.")),this.cleanup(),this.segmentManager.abortSegment(e.url,(0,o.getByteRange)(e)),this.stats.aborted=!0;const n=null==t?void 0:t.onAbort;n&&n(this.stats,e,void 0)}},{key:"successPlaylist",value:function(e,t,n){this.cleanup();const r=performance.now();this.stats.loading.end=r,this.stats.loaded=e.response.length,this.stats.total=e.response.length,n.onSuccess({url:e.responseURL,data:e.response},this.stats,t,void 0)}},{key:"successSegment",value:function(e,t,n){this.cleanup();const r=performance.now();this.stats.loading.end=r,this.stats.loaded=e.byteLength,this.stats.total=e.byteLength,n.onProgress&&n.onProgress(this.stats,t,e,void 0),n.onSuccess({url:t.url,data:e},this.stats,t,void 0)}},{key:"error",value:function(e,t,n){this.cleanup(),n.onError(e,t,void 0)}},{key:"cleanup",value:function(){this.interval&&(clearInterval(this.interval),this.interval=void 0),this.loader&&(this.loader.off(a.Events.SegmentStartLoad,this.boundOnSegmentStartLoad),this.loader.off(a.Events.SegmentSize,this.boundOnUpdateSegmentSize),this.loader.off(a.Events.PieceBytesDownloaded,this.boundOnUpdateLoaded),this.loader.off(a.Events.SegmentAbort,this.boundOnSegmentAbort))}},{key:"onSegmentAbort",value:function(e){var t;if(!this.isSegment(e))return;this.debug("Aborting by p2p-media-loader fragment ".concat(this.debugId||"",".")),this.stats.aborted=!0;const n=null===(t=this.callbacks)||void 0===t?void 0:t.onAbort;n&&n(this.stats,this.context,void 0),this.cleanup()}},{key:"onUpdateSegmentSize",value:function(e,t){this.isSegment(e)&&(this.stats.total=t)}},{key:"onUpdateLoaded",value:function(e,t,n){this.isSegment(t)&&(this.stats.loaded+=n)}},{key:"onSegmentStartLoad",value:function(t,n){this.interval&&"http"===t&&this.isSegment(n)&&(clearInterval(this.interval),this.interval=void 0,e.updateStatsToStartLoading(this.stats),this.loader.on(a.Events.PieceBytesDownloaded,this.boundOnUpdateLoaded))}},{key:"isSegment",value:function(e){return e.url===this.context.url&&e.range===(0,o.byteRangeToString)(this.byteRange)}}])&&r(t.prototype,n),i&&r(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}()},1819:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.initJwPlayer=t.initMediaElementJsPlayer=t.initVideoJsHlsJsPlugin=t.initVideoJsContribHlsJsPlayer=t.initFlowplayerHlsJsPlayer=t.initClapprPlayer=t.initHlsJsPlayer=t.version=void 0,t.version="0.6.2",i(n(9004),t),i(n(7986),t);const a=(0,s(n(7642)).default)("p2pml:hlsjs-init");function o(e){e&&e.config&&e.config.loader&&"function"==typeof e.config.loader.getEngine&&u(e,e.config.loader.getEngine())}function u(e,t){e.on("hlsFragChanged",((e,n)=>{a("HLS Frag changed.",n);const r=n.frag;t.setPlayingSegment(r.url,2!==r.byteRange.length?void 0:{offset:r.byteRange[0],length:r.byteRange[1]-r.byteRange[0]},r.start,r.duration)})),e.on("hlsDestroying",(async()=>{await t.destroy()})),e.on("hlsError",((n,r)=>{if("bufferStalledError"===r.details){const n=void 0===e.media?e.el_:e.media;n&&t.setPlayingSegmentByCurrentTime(n.currentTime)}})),e.on("seeking",(()=>{a("Player seeking."),t.abortCurrentRequest()}))}t.initHlsJsPlayer=o,t.initClapprPlayer=function(e){e.on("play",(()=>{const t=e.core.getCurrentPlayback();t._hls&&!t._hls._p2pm_linitialized&&(t._hls._p2pm_linitialized=!0,o(e.core.getCurrentPlayback()._hls))}))},t.initFlowplayerHlsJsPlayer=function(e){e.on("ready",(()=>{var t;return o(null!==(t=e.engine.hlsjs)&&void 0!==t?t:e.engine.hls)}))},t.initVideoJsContribHlsJsPlayer=function(e){e.ready((()=>{const t=e.tech_.options_;t&&t.hlsjsConfig&&t.hlsjsConfig.loader&&"function"==typeof t.hlsjsConfig.loader.getEngine&&u(e.tech_,t.hlsjsConfig.loader.getEngine())}))},t.initVideoJsHlsJsPlugin=function(){null!=videojs&&null!=videojs.Html5Hlsjs&&videojs.Html5Hlsjs.addHook("beforeinitialize",((e,t)=>{t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine&&u(t,t.config.loader.getEngine())}))},t.initMediaElementJsPlayer=function(e){e.addEventListener("hlsFragChanged",(t=>{const n=e.hlsPlayer;if(n&&n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine){const e=n.config.loader.getEngine();if(t.data&&t.data.length>1){const n=t.data[1].frag;e.setPlayingSegment(n.url,2!==n.byteRange.length?void 0:{offset:n.byteRange[0],length:n.byteRange[1]-n.byteRange[0]},n.start,n.duration)}}})),e.addEventListener("hlsDestroying",(async()=>{const t=e.hlsPlayer;if(t&&t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine){const e=t.config.loader.getEngine();await e.destroy()}})),e.addEventListener("hlsError",(t=>{const n=e.hlsPlayer;n&&n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine&&void 0!==t.data&&"bufferStalledError"===t.data.details&&n.config.loader.getEngine().setPlayingSegmentByCurrentTime(n.media.currentTime)}))},t.initJwPlayer=function(e,t){const n=setInterval((()=>{e.hls&&e.hls.config&&(clearInterval(n),Object.assign(e.hls.config,t),o(e.hls))}),200)}},7986:function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentManager=void 0;const o=a(n(7642)),u=n(7382),d=n(6026),l=n(701),g={forwardSegmentCount:20,swarmId:void 0,assetsStorage:void 0};let c=function(){function e(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};r(this,e),this.debug=(0,o.default)("p2pml:segment-manager"),this.masterPlaylist=null,this.variantPlaylists=new Map,this.segmentRequest=null,this.fetch=function(){return fetch.apply(void 0,arguments)},this.playQueue=[],this.onSegmentLoaded=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&(0,l.byteRangeToString)(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onSuccess(e.data.slice(0),e.downloadBandwidth),this.segmentRequest=null)},this.onSegmentError=(e,t)=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&(0,l.byteRangeToString)(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onError(t),this.segmentRequest=null)},this.onSegmentAbort=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&(0,l.byteRangeToString)(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onError("Loading aborted: internal abort"),this.segmentRequest=null)},this.settings=Object.assign(Object.assign({},g),n),this.loader=t,this.loader.on(u.Events.SegmentLoaded,this.onSegmentLoaded),this.loader.on(u.Events.SegmentError,this.onSegmentError),this.loader.on(u.Events.SegmentAbort,this.onSegmentAbort),i.localTransport&&(this.fetch=i.localTransport)}return s(e,[{key:"getSettings",value:function(){return this.settings}},{key:"processPlaylist",value:function(e,t,n){const r=new d.Parser;r.push(t),r.end();const i=new m(e,n,r.manifest);if(i.manifest.playlists){this.masterPlaylist=i;for(const[e,t]of this.variantPlaylists){const{streamSwarmId:n,found:r,index:i}=this.getStreamSwarmId(t.requestUrl);r?(t.streamSwarmId=n,t.streamId="V"+i.toString()):this.variantPlaylists.delete(e)}}else{const{streamSwarmId:t,found:n,index:r}=this.getStreamSwarmId(e);(n||null===this.masterPlaylist)&&(i.streamSwarmId=t,i.streamId=null===this.masterPlaylist?void 0:"V"+r.toString(),this.variantPlaylists.set(e,i),this.updateSegments())}}},{key:"loadPlaylist",value:async function(e){const t=this.settings.assetsStorage;let n;if(void 0!==t){let r;r=this.getMasterSwarmId(),void 0===r&&(r=e.split("?")[0]);const i=await t.getAsset(e,void 0,r);if(void 0!==i)n={responseURL:i.responseUri,response:i.data};else{const i=await this.loadContent(e);n={responseURL:i.url,response:await i.text()},t.storeAsset({masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e,masterSwarmId:r,requestUri:e,responseUri:n.responseURL,data:n.response})}}else{const t=await this.loadContent(e);n={responseURL:t.url,response:await t.text()}}return this.processPlaylist(e,n.response,n.responseURL),n}},{key:"loadSegment",value:async function(e,t){var n;const r=this.getSegmentLocation(e,t),i=(0,l.byteRangeToString)(t);if(!r){let t;const r=this.settings.assetsStorage;if(void 0!==r){let s,a=null===(n=this.masterPlaylist)||void 0===n?void 0:n.requestUrl;if(s=this.getMasterSwarmId(),void 0===s&&1===this.variantPlaylists.size){const e=this.variantPlaylists.values().next();e.done||(s=e.value.requestUrl.split("?")[0])}if(void 0===a&&1===this.variantPlaylists.size){const e=this.variantPlaylists.values().next();e.done||(a=e.value.requestUrl)}if(void 0!==s&&void 0!==a){const n=await r.getAsset(e,i,s);if(void 0!==n)t=n.data;else{const n=await this.loadContent(e,i);t=await n.arrayBuffer(),r.storeAsset({masterManifestUri:a,masterSwarmId:s,requestUri:e,requestRange:i,responseUri:n.url,data:t})}}}if(void 0===t){const n=await this.loadContent(e,i);t=await n.arrayBuffer()}return{content:t,downloadBandwidth:0}}const s=(r.playlist.manifest.mediaSequence?r.playlist.manifest.mediaSequence:0)+r.segmentIndex;this.playQueue.length>0&&this.playQueue[this.playQueue.length-1].segmentSequence!==s-1&&(this.playQueue=[]),this.segmentRequest&&this.segmentRequest.onError("Cancel segment request: simultaneous segment requests are not supported");const a=new Promise(((n,i)=>{this.segmentRequest=new p(e,t,s,r.playlist.requestUrl,((e,t)=>n({content:e,downloadBandwidth:t})),(e=>i(e)))}));return this.playQueue.push({segmentUrl:e,segmentByteRange:t,segmentSequence:s}),this.loadSegments(r.playlist,r.segmentIndex,!0),a}},{key:"setPlayingSegment",value:function(e,t,n,r){const i=this.playQueue.findIndex((n=>n.segmentUrl===e&&(0,l.compareByteRanges)(n.segmentByteRange,t)));this.debug("Set playing segment to index %d",i,this.playQueue),i>=0&&(this.playQueue=this.playQueue.slice(i),this.playQueue[0].playPosition={start:n,duration:r},this.updateSegments())}},{key:"setPlayingSegmentByCurrentTime",value:function(e){if(0===this.playQueue.length||!this.playQueue[0].playPosition)return;const t=this.playQueue[0].playPosition;t.start+t.duration-e<.2&&(this.playQueue=this.playQueue.slice(1),this.updateSegments())}},{key:"abortSegment",value:function(e,t){this.segmentRequest&&this.segmentRequest.segmentUrl===e&&(0,l.compareByteRanges)(this.segmentRequest.segmentByteRange,t)&&(this.segmentRequest.onSuccess(void 0,0),this.segmentRequest=null)}},{key:"abortCurrentSegment",value:function(){this.segmentRequest&&(this.segmentRequest.onSuccess(void 0,0),this.segmentRequest=null)}},{key:"destroy",value:async function(){this.segmentRequest&&(this.segmentRequest.onError("Loading aborted: object destroyed"),this.segmentRequest=null),this.masterPlaylist=null,this.variantPlaylists.clear(),this.playQueue=[],void 0!==this.settings.assetsStorage&&await this.settings.assetsStorage.destroy(),await this.loader.destroy()}},{key:"updateSegments",value:function(){if(!this.segmentRequest)return;const e=this.getSegmentLocation(this.segmentRequest.segmentUrl,this.segmentRequest.segmentByteRange);this.debug("update segments",e),e&&this.loadSegments(e.playlist,e.segmentIndex,!1)}},{key:"getSegmentLocation",value:function(e,t){for(const n of this.variantPlaylists.values()){const r=n.getSegmentIndex(e,t);if(r>=0)return{playlist:n,segmentIndex:r}}}},{key:"loadSegments",value:async function(e,t,n){var r;const i=[],s=e.manifest.segments,a=null!==(r=e.manifest.mediaSequence)&&void 0!==r?r:0;let o=null,u=Math.max(0,this.playQueue.length-1);const d=this.getMasterSwarmId();this.debug("load segments",u,t);for(let g=t;g<s.length&&i.length<this.settings.forwardSegmentCount;++g){const t=e.manifest.segments[g],r=e.getSegmentAbsoluteUrl(t.uri),s=t.byterange,c=this.getSegmentId(e,a+g);i.push({id:c,url:r,masterSwarmId:void 0!==d?d:e.streamSwarmId,masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e.requestUrl,streamId:e.streamId,sequence:(a+g).toString(),range:(0,l.byteRangeToString)(s),priority:u++}),n&&!o&&(o=c)}if(this.loader.load(i,e.streamSwarmId),o){const e=await this.loader.getSegment(o);e&&this.onSegmentLoaded(e)}}},{key:"getSegmentId",value:function(e,t){return"".concat(e.streamSwarmId,"+").concat(t)}},{key:"getMasterSwarmId",value:function(){const e=this.settings.swarmId&&0!==this.settings.swarmId.length?this.settings.swarmId:void 0;return void 0!==e?e:null!==this.masterPlaylist?this.masterPlaylist.requestUrl.split("?")[0]:void 0}},{key:"getStreamSwarmId",value:function(e){const t=this.getMasterSwarmId();if(this.masterPlaylist&&this.masterPlaylist.manifest.playlists&&t)for(let n=0;n<this.masterPlaylist.manifest.playlists.length;++n)if(new URL(this.masterPlaylist.manifest.playlists[n].uri,this.masterPlaylist.responseUrl).toString()===e)return{streamSwarmId:"".concat(t,"+V").concat(n),found:!0,index:n};return{streamSwarmId:null!=t?t:e.split("?")[0],found:!1,index:-1}}},{key:"loadContent",value:async function(e,t){const n=new Headers;return t&&n.append("Range",t),this.fetch(e,{headers:n})}}]),e}();t.SegmentManager=c;let m=function(){function e(t,n,i){r(this,e),this.requestUrl=t,this.responseUrl=n,this.manifest=i,this.streamSwarmId=""}return s(e,[{key:"getSegmentIndex",value:function(e,t){for(let n=0;n<this.manifest.segments.length;++n){const r=this.manifest.segments[n];if(e===this.getSegmentAbsoluteUrl(r.uri)&&(0,l.compareByteRanges)(r.byterange,t))return n}return-1}},{key:"getSegmentAbsoluteUrl",value:function(e){return new URL(e,this.responseUrl).toString()}}]),e}(),p=s((function e(t,n,i,s,a,o){r(this,e),this.segmentUrl=t,this.segmentByteRange=n,this.segmentSequence=i,this.playlistRequestUrl=s,this.onSuccess=a,this.onError=o}))},1998:(e,t,n)=>{var r=n(6086).Buffer;function i(e,t){this._block=r.alloc(e),this._finalSize=t,this._blockSize=e,this._len=0}i.prototype.update=function(e,t){"string"==typeof e&&(e=r.from(e,t=t||"utf8"));for(var n=this._block,i=this._blockSize,s=e.length,a=this._len,o=0;o<s;){for(var u=a%i,d=Math.min(s-o,i-u),l=0;l<d;l++)n[u+l]=e[o+l];o+=d,(a+=d)%i==0&&this._update(n)}return this._len+=s,this},i.prototype.digest=function(e){var t=this._len%this._blockSize;this._block[t]=128,this._block.fill(0,t+1),t>=this._finalSize&&(this._update(this._block),this._block.fill(0));var n=8*this._len;if(n<=4294967295)this._block.writeUInt32BE(n,this._blockSize-4);else{var r=(4294967295&n)>>>0;this._block.writeUInt32BE((n-r)/4294967296,this._blockSize-8),this._block.writeUInt32BE(r,this._blockSize-4)}this._update(this._block);var i=this._hash();return e?i.toString(e):i},i.prototype._update=function(){throw new Error("_update must be implemented by subclass")},e.exports=i},599:(e,t,n)=>{var r=n(4540),i=n(1998),s=n(6086).Buffer,a=[1518500249,1859775393,-1894007588,-899497514],o=new Array(80);function u(){this.init(),this._w=o,i.call(this,64,56)}function d(e){return e<<5|e>>>27}function l(e){return e<<30|e>>>2}function g(e,t,n,r){return 0===e?t&n|~t&r:2===e?t&n|t&r|n&r:t^n^r}r(u,i),u.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},u.prototype._update=function(e){for(var t,n=this._w,r=0|this._a,i=0|this._b,s=0|this._c,o=0|this._d,u=0|this._e,c=0;c<16;++c)n[c]=e.readInt32BE(4*c);for(;c<80;++c)n[c]=(t=n[c-3]^n[c-8]^n[c-14]^n[c-16])<<1|t>>>31;for(var m=0;m<80;++m){var p=~~(m/20),f=d(r)+g(p,i,s,o)+u+n[m]+a[p]|0;u=o,o=s,s=l(i),i=r,r=f}this._a=r+this._a|0,this._b=i+this._b|0,this._c=s+this._c|0,this._d=o+this._d|0,this._e=u+this._e|0},u.prototype._hash=function(){var e=s.allocUnsafe(20);return e.writeInt32BE(0|this._a,0),e.writeInt32BE(0|this._b,4),e.writeInt32BE(0|this._c,8),e.writeInt32BE(0|this._d,12),e.writeInt32BE(0|this._e,16),e},e.exports=u}}]);
//# sourceMappingURL=819.chunk.js.map