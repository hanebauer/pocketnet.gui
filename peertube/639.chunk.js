"use strict";(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[639],{1639:(e,t,i)=>{i.r(t),i.d(t,{P2pMediaLoaderPlugin:()=>b});var s=i(3654),r=i.n(s),n=i(7382),o=i(1819),l=i(7862),a=i(4538),h=i.n(a),u=i(8859),d=i(8724);function c(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}const p=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.paused=!0,this.registerListeners()}var t,i,s;return t=e,s=[{key:"isLevelAllowed",value:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return-1===t.indexOf(e)}},{key:"getMaxLevelByMediaSize",value:function(e,t,i){if(!e||!e.length)return-1;let s=e.length-1;for(let o=0;o<e.length;o+=1){let l=e[o];if((l.width>=t||l.height>=i)&&(r=l,!(n=e[o+1])||r.width!==n.width||r.height!==n.height)){s=o;break}}var r,n;return s}}],(i=[{key:"setStreamController",value:function(e){this.streamController=e}},{key:"destroy",value:function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}},{key:"registerListeners",value:function(){let{hls:e}=this;e.on(d.z.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(d.z.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(d.z.MANIFEST_PARSED,this.onManifestParsed,this),e.on(d.z.BUFFER_CODECS,this.onBufferCodecs,this),e.on(d.z.MEDIA_DETACHING,this.onMediaDetaching,this)}},{key:"unregisterListener",value:function(){let{hls:e}=this;e.off(d.z.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(d.z.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(d.z.MANIFEST_PARSED,this.onManifestParsed,this),e.off(d.z.BUFFER_CODECS,this.onBufferCodecs,this),e.off(d.z.MEDIA_DETACHING,this.onMediaDetaching,this)}},{key:"onFpsDropLevelCapping",value:function(t,i){e.isLevelAllowed(i.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(i.droppedLevel)}},{key:"onMediaAttaching",value:function(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null}},{key:"onManifestParsed",value:function(e,t){let i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}},{key:"onBufferCodecs",value:function(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}},{key:"onMediaDetaching",value:function(){this.stopCapping()}},{key:"detectPlayerSize",value:function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){let e=this.hls.levels;if(e.length){let t=this.hls;t.autoLevelCapping=this.getMaxLevel(e.length-1),t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}},{key:"getMaxLevel",value:function(t){let i=this.hls.levels;if(!i.length)return-1;let s=i.filter(((i,s)=>e.isLevelAllowed(s,this.restrictedLevels)&&s<=t));return this.clientRect=null,e.getMaxLevelByMediaSize(s,this.mediaWidth,this.mediaHeight)}},{key:"capp",value:function(){this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),this.detectPlayerSize()}},{key:"startCapping",value:function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e4),this.detectPlayerSize())}},{key:"stopCapping",value:function(){this.restrictedLevels=[],this.firstLevel=-1,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}},{key:"getDimensions",value:function(){if(this.paused&&this.clientRectLast)return this.clientRectLast;if(this.clientRect)return this.clientRect;let e=this.media,t={width:0,height:0};if(e){let i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,t.width||t.height||(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRectLast=this.clientRect=t,t}},{key:"mediaWidth",get:function(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function(){let e=1;try{e=self.devicePixelRatio}catch(t){}return e>1.5&&(e=1.5),e}}])&&c(t.prototype,i),s&&c(t,s),Object.defineProperty(t,"prototype",{writable:!1}),e}();function f(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}let v=function(){function e(t,i,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.errorCounts={},this.maxNetworkErrorRecovery=5,this.hlsjsConfig=null,this._duration=null,this.metadata=null,this.isLive=null,this.dvrDuration=null,this.edgeMargin=null,this.handlers={play:null},this.vjs=t,this.source=i,this.tech=s,this.tech.name_="Hlsjs",this.videoElement=s.el(),this.player=t(s.options_.playerId),this.videoElement.addEventListener("error",(e=>{let t,i=(e.currentTarget||e.target).error;if(i){switch(u.k.info(i),i.code){case i.MEDIA_ERR_ABORTED:t="You aborted the video playback";break;case i.MEDIA_ERR_DECODE:t="The video playback was aborted due to a corruption problem or because the video used features your browser did not support",this._handleMediaError(i);break;case i.MEDIA_ERR_NETWORK:t="A network error caused the video download to fail part-way";break;case i.MEDIA_ERR_SRC_NOT_SUPPORTED:t="The video could not be loaded, either because the server or network failed or because the format is not supported";break;default:t=i.message}u.k.error(`MEDIA_ERROR: ${t}`)}})),this.initialize()}var t,i,s;return t=e,s=[{key:"addHook",value:function(t,i){(e.hooks[t]=this.hooks[t]||[]).push(i)}},{key:"removeHook",value:function(t,i){if(void 0===e.hooks[t])return!1;let s=e.hooks[t].indexOf(i);return-1!==s&&(e.hooks[t].splice(s,1),!0)}}],(i=[{key:"duration",value:function(){return this._duration===1/0?1/0:isNaN(this.videoElement.duration)?this._duration||0:this.videoElement.duration}},{key:"seekable",value:function(){if(this.hls.media){if(!this.isLive)return this.vjs.createTimeRanges(0,this.hls.media.duration);let e=Math.round(this.hls.media.duration-this.dvrDuration),t=Math.round(this.hls.media.duration-this.edgeMargin);return this.vjs.createTimeRanges(e,t)}return this.vjs.createTimeRanges()}},{key:"dispose",value:function(){this.videoElement.removeEventListener("play",this.handlers.play);let e=this.hls;e.log=e.warn=()=>{},console.log("DESTROY",this.hls),this.hls.destroy()}},{key:"_executeHooksFor",value:function(t){if(void 0!==e.hooks[t])for(let i=0;i<e.hooks[t].length;i++)e.hooks[t][i](this.player,this.hls)}},{key:"_handleMediaError",value:function(e){if(3==e.code){var t=this.player.currentTime()+2;return this.dispose(),this._initHlsjs(),this.player.currentTime(t),this.player.play(),void this.hls.once(h().Events.FRAG_LOADED,(()=>{this.player.play()}))}return 1===this.errorCounts[h().ErrorTypes.MEDIA_ERROR]?(u.k.info("trying to recover media error"),void this.hls.recoverMediaError()):2===this.errorCounts[h().ErrorTypes.MEDIA_ERROR]?(u.k.info("2nd try to recover media error (by swapping audio codec"),this.hls.swapAudioCodec(),void this.hls.recoverMediaError()):void(this.errorCounts[h().ErrorTypes.MEDIA_ERROR]>2&&(u.k.info("bubbling media error up to VIDEOJS"),this.hls.destroy(),this.tech.error=()=>e,this.tech.trigger("error")))}},{key:"_handleNetworkError",value:function(e){if(this.errorCounts[h().ErrorTypes.NETWORK_ERROR]<=this.maxNetworkErrorRecovery)return u.k.info("trying to recover network error"),setTimeout((()=>this.hls.startLoad()),1e3),void this.hls.once(h().Events.FRAG_LOADED,(()=>{this.errorCounts[h().ErrorTypes.NETWORK_ERROR]=0}));u.k.info("bubbling network error up to VIDEOJS"),this.hls.destroy(),this.tech.error=()=>e,this.tech.trigger("error")}},{key:"_onError",value:function(e,t){let i={message:`HLS.js error: ${t.type} - fatal: ${t.fatal} - ${t.details}`};this.errorCounts[t.type]?this.errorCounts[t.type]+=1:this.errorCounts[t.type]=1,t.fatal?u.k.warn(i.message):u.k.error(i.message,{data:t}),t.type===h().ErrorTypes.NETWORK_ERROR?(i.code=2,this._handleNetworkError(i)):t.fatal&&t.type===h().ErrorTypes.MEDIA_ERROR&&"manifestIncompatibleCodecsError"!==t.details?(i.code=3,this._handleMediaError(i)):t.fatal&&(this.hls.destroy(),u.k.info("bubbling error up to VIDEOJS"),this.tech.error=()=>i,this.tech.trigger("error"))}},{key:"buildLevelLabel",value:function(e){return this.player.srOptions_.levelLabelHandler?this.player.srOptions_.levelLabelHandler(e):e.height?e.height+"p":e.width?Math.round(9*e.width/16)+"p":e.bitrate?e.bitrate/1e3+"kbps":"0"}},{key:"_notifyVideoQualities",value:function(){if(!this.metadata)return;let e=[];this.metadata.levels.forEach(((t,i)=>{e.push({id:i,height:t.height,width:t.width,bitrate:t.bitrate,label:this.buildLevelLabel(t),selected:t.id===this.hls.manualLevel,selectCallback:()=>{this.hls.currentLevel=i}})})),e.push({id:-1,label:this.player.localize("Auto"),selected:!0,selectCallback:()=>this.hls.currentLevel=-1}),this.player.peertubeResolutions().add(e)}},{key:"_startLoad",value:function(){this.hls.startLoad(-1),this.videoElement.removeEventListener("play",this.handlers.play)}},{key:"_oneLevelObjClone",value:function(e){let t={},i=Object.keys(e);for(let s=0;s<i.length;s++)t[i[s]]=e[i[s]];return t}},{key:"_onMetaData",value:function(e,t){this.metadata=t,this._notifyVideoQualities()}},{key:"_initHlsjs",value:function(){let e=this.player.srOptions_,t=(null==e?void 0:e.hlsjsConfig)||this.tech.options_.hlsjsConfig;this.hlsjsConfig=t?this._oneLevelObjClone(t):{},["","auto"].includes(this.videoElement.preload)&&!this.videoElement.autoplay&&void 0===this.hlsjsConfig.autoStartLoad&&(this.hlsjsConfig.autoStartLoad=!1),!1===this.hlsjsConfig.autoStartLoad&&(this.handlers.play=this._startLoad.bind(this),this.videoElement.addEventListener("play",this.handlers.play)),this.hlsjsConfig.capLevelController=p,this.hls=new(h())(this.hlsjsConfig),this.player.hls=this.hls,this.hls.on(h().Events.ERROR,((e,t)=>this._onError(e,t))),this.hls.on(h().Events.MANIFEST_PARSED,((e,t)=>this._onMetaData(e,t))),this.hls.on(h().Events.LEVEL_LOADED,((e,t)=>{this.hlsjsConfig.liveSyncDuration?this.edgeMargin=this.hlsjsConfig.liveSyncDuration:this.hlsjsConfig.liveSyncDurationCount&&(this.edgeMargin=this.hlsjsConfig.liveSyncDurationCount*t.details.targetduration),this.isLive=t.details.live,this.dvrDuration=t.details.totalduration,this._duration=this.isLive?1/0:t.details.totalduration,this.isLive&&(this.maxNetworkErrorRecovery=300)})),this.hls.once(h().Events.FRAG_LOADED,(()=>{this.tech.trigger("loadedmetadata")})),this.hls.on(h().Events.LEVEL_SWITCHING,((e,t)=>{let i=this.hls.autoLevelEnabled?-1:t.level,s=this.hls.autoLevelEnabled?t.level:-1;this.player.peertubeResolutions().select({id:i,autoResolutionChosenId:s,byEngine:!0})})),this.hls.attachMedia(this.videoElement),this.hls.loadSource(this.source.src)}},{key:"initialize",value:function(){this._initHlsjs()}}])&&f(t.prototype,i),s&&f(t,s),Object.defineProperty(t,"prototype",{writable:!1}),e}();function y(e,t){return y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},y(e,t)}function g(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function E(e){return E=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},E(e)}var m;v.hooks={},((m=r()).registerPlugin||m.plugin)("hlsjs",(function(e){let t=this;e&&(t.srOptions_||(t.srOptions_={}),t.srOptions_.hlsjsConfig||(t.srOptions_.hlsjsConfig=e.hlsjsConfig),e.levelLabelHandler&&!t.srOptions_.levelLabelHandler&&(t.srOptions_.levelLabelHandler=e.levelLabelHandler))})),function(e){if(!h().isSupported())return void u.k.warn("Hls.js is not supported in this browser!");let t=e.getTech("Html5");t?(t.registerSourceHandler({canHandleSource:function(e){return/^application\/x-mpegURL|application\/vnd\.apple\.mpegurl$/i.test(e.type)?"probably":/\.m3u8/i.test(e.src)?"maybe":""},handleSource:function(t,i){return i.hlsProvider&&(console.log("HERE"),i.hlsProvider.dispose()),console.log("???ASD"),i.hlsProvider=new v(e,t,i),i.hlsProvider}},0),e.Html5Hlsjs=v):u.k.error("No Hml5 tech found in videojs")}(r());let b=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&y(e,t)}(d,e);var t,i,s,a,h=(s=d,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=E(s);if(a){var i=E(this).constructor;e=Reflect.construct(t,arguments,i)}else e=t.apply(this,arguments);return g(this,e)});function d(e,t){var i;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,d),(i=h.call(this,e)).CONSTANTS={INFO_SCHEDULER:1e3},i.statsP2PBytes={pendingDownload:[],pendingUpload:[],numPeers:0,totalDownload:0,totalUpload:0},i.statsHTTPBytes={pendingDownload:[],pendingUpload:[],totalDownload:0,totalUpload:0},i.options=t,!i.options)return g(i);if(r().Html5Hlsjs)(0,o.initVideoJsContribHlsJsPlayer)(e);else if(u.k.warn("HLS.js does not seem to be supported. Try to fallback to built in HLS."),!e.canPlayType("application/vnd.apple.mpegurl")){let t="Cannot fallback to built-in HLS";return u.k.warn(t),e.ready((()=>e.trigger("error",new Error(t)))),g(i)}return i.startTime=(0,l.h8)(i.options.startTime),e.src({type:i.options.type,src:i.options.src}),e.ready((()=>{i.initializeCore(),i.hlsjs=e.hls,r().Html5Hlsjs&&i.initializePlugin()})),i}return t=d,(i=[{key:"dispose",value:function(){this.hlsjs&&this.hlsjs.destroy(),this.p2pEngine&&this.p2pEngine.destroy(),clearInterval(this.networkInfoInterval)}},{key:"getCurrentLevel",value:function(){return this.hlsjs.levels[this.hlsjs.currentLevel]}},{key:"getLiveLatency",value:function(){return Math.round(this.hlsjs.latency)}},{key:"getHLSJS",value:function(){return this.hlsjs}},{key:"initializeCore",value:function(){this.player.one("play",(()=>{this.player.addClass("vjs-has-big-play-button-clicked")})),this.player.one("canplay",(()=>{this.startTime&&this.player.currentTime(this.startTime)}))}},{key:"initializePlugin",value:function(){(0,o.initHlsJsPlayer)(this.hlsjs),this.p2pEngine=this.options.loader.getEngine(),this.p2pEngine.on(n.Events.SegmentError,((e,t)=>{u.k.error(`Segment ${e.id} error.`,t),this.options.redundancyUrlManager.removeBySegmentUrl(e.requestUrl)})),this.statsP2PBytes.numPeers=1+this.options.redundancyUrlManager.countBaseUrls(),this.runStats()}},{key:"runStats",value:function(){this.p2pEngine.on(n.Events.PieceBytesDownloaded,((e,t,i)=>{let s="p2p"===e?this.statsP2PBytes:this.statsHTTPBytes;s.pendingDownload.push(i),s.totalDownload+=i})),this.p2pEngine.on(n.Events.PieceBytesUploaded,((e,t,i)=>{let s="p2p"===e?this.statsP2PBytes:this.statsHTTPBytes;s.pendingUpload.push(i),s.totalUpload+=i})),this.p2pEngine.on(n.Events.PeerConnect,(()=>this.statsP2PBytes.numPeers++)),this.p2pEngine.on(n.Events.PeerClose,(()=>this.statsP2PBytes.numPeers--)),this.networkInfoInterval=setInterval((()=>{let e=this.arraySum(this.statsP2PBytes.pendingDownload),t=this.arraySum(this.statsP2PBytes.pendingUpload),i=this.arraySum(this.statsHTTPBytes.pendingDownload),s=this.arraySum(this.statsHTTPBytes.pendingUpload);return this.statsP2PBytes.pendingDownload=[],this.statsP2PBytes.pendingUpload=[],this.statsHTTPBytes.pendingDownload=[],this.statsHTTPBytes.pendingUpload=[],this.player.trigger("p2pInfo",{source:"p2p-media-loader",http:{downloadSpeed:i,uploadSpeed:s,downloaded:this.statsHTTPBytes.totalDownload,uploaded:this.statsHTTPBytes.totalUpload},p2p:{downloadSpeed:e,uploadSpeed:t,numPeers:this.statsP2PBytes.numPeers,downloaded:this.statsP2PBytes.totalDownload,uploaded:this.statsP2PBytes.totalUpload},bandwidthEstimate:this.hlsjs.bandwidthEstimate/8})}),this.CONSTANTS.INFO_SCHEDULER)}},{key:"arraySum",value:function(e){return e.reduce(((e,t)=>e+t),0)}}])&&function(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(t.prototype,i),Object.defineProperty(t,"prototype",{writable:!1}),d}(r().getPlugin("plugin"));r().registerPlugin("p2pMediaLoader",b)}}]);
//# sourceMappingURL=639.chunk.js.map