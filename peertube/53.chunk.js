"use strict";(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[53],{5053:(e,t,i)=>{i.r(t),i.d(t,{P2pMediaLoaderPlugin:()=>_});var s=i(1858),n=i.n(s),r=i(9502),a=i(3819),o=i(7746),l=i(4356),h=i.n(l),u=i(8724);function d(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}let c=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.paused=!0,this.hls.pauseCapping=()=>{this.paused=!0},this.hls.resumeCapping=()=>{this.paused=!1},this.registerListeners()}var t,i,s;return t=e,i=[{key:"setStreamController",value:function(e){this.streamController=e}},{key:"destroy",value:function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}},{key:"registerListeners",value:function(){const{hls:e}=this;e.on(u.z.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(u.z.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(u.z.MANIFEST_PARSED,this.onManifestParsed,this),e.on(u.z.BUFFER_CODECS,this.onBufferCodecs,this),e.on(u.z.MEDIA_DETACHING,this.onMediaDetaching,this)}},{key:"unregisterListener",value:function(){const{hls:e}=this;e.off(u.z.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(u.z.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(u.z.MANIFEST_PARSED,this.onManifestParsed,this),e.off(u.z.BUFFER_CODECS,this.onBufferCodecs,this),e.off(u.z.MEDIA_DETACHING,this.onMediaDetaching,this)}},{key:"onFpsDropLevelCapping",value:function(t,i){e.isLevelAllowed(i.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(i.droppedLevel)}},{key:"onMediaAttaching",value:function(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null}},{key:"onManifestParsed",value:function(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}},{key:"onBufferCodecs",value:function(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}},{key:"onMediaDetaching",value:function(){this.stopCapping()}},{key:"detectPlayerSize",value:function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){const e=this.hls.levels;if(e.length){const t=this.hls;t.autoLevelCapping=this.getMaxLevel(e.length-1),t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}},{key:"getMaxLevel",value:function(t){const i=this.hls.levels;if(!i.length)return-1;const s=i.filter(((i,s)=>e.isLevelAllowed(s,this.restrictedLevels)&&s<=t));return this.clientRect=null,e.getMaxLevelByMediaSize(s,this.mediaWidth,this.mediaHeight)}},{key:"capp",value:function(){this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),this.detectPlayerSize()}},{key:"startCapping",value:function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e4),this.detectPlayerSize())}},{key:"stopCapping",value:function(){this.restrictedLevels=[],this.firstLevel=-1,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}},{key:"getDimensions",value:function(){if(this.paused&&this.clientRectLast)return this.clientRectLast;if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,t.width||t.height||(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRectLast=this.clientRect=t,t}},{key:"mediaWidth",get:function(){return this.getDimensions().width*e.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*e.contentScaleFactor}}],s=[{key:"contentScaleFactor",get:function(){let e=1;try{e=self.devicePixelRatio}catch(e){}return e>1.5&&(e=1.5),e}},{key:"isLevelAllowed",value:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return-1===t.indexOf(e)}},{key:"getMaxLevelByMediaSize",value:function(e,t,i){if(!e||!e.length)return-1;let s=e.length-1;for(let a=0;a<e.length;a+=1){const o=e[a];if((o.width>=t||o.height>=i)&&(n=o,!(r=e[a+1])||n.width!==r.width||n.height!==r.height)){s=a;break}}var n,r;return s}}],i&&d(t.prototype,i),s&&d(t,s),Object.defineProperty(t,"prototype",{writable:!1}),e}();const p=c;function f(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function g(e){const t=this;e&&(t.srOptions_||(t.srOptions_={}),t.srOptions_.hlsjsConfig||(t.srOptions_.hlsjsConfig=e.hlsjsConfig),t.srOptions_.captionConfig||(t.srOptions_.captionConfig=e.captionConfig),e.levelLabelHandler&&!t.srOptions_.levelLabelHandler&&(t.srOptions_.levelLabelHandler=e.levelLabelHandler))}let v=function(){function e(t,i,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.errorCounts={},this.hlsjsConfig=null,this._duration=null,this.metadata=null,this.isLive=null,this.dvrDuration=null,this.edgeMargin=null,this.handlers={play:null,playing:null,textTracksChange:null,audioTracksChange:null},this.uiTextTrackHandled=!1,this.vjs=t,this.source=i,this.tech=s,this.tech.name_="Hlsjs",this.videoElement=s.el(),this.player=t(s.options_.playerId),this.videoElement.addEventListener("error",(e=>{let t;const i=(e.currentTarget||e.target).error;if(i)switch(i.code){case i.MEDIA_ERR_ABORTED:t="You aborted the video playback";break;case i.MEDIA_ERR_DECODE:t="The video playback was aborted due to a corruption problem or because the video used features your browser did not support",this._handleMediaError(i);break;case i.MEDIA_ERR_NETWORK:t="A network error caused the video download to fail part-way";break;case i.MEDIA_ERR_SRC_NOT_SUPPORTED:t="The video could not be loaded, either because the server or network failed or because the format is not supported";break;default:t=i.message}})),this.initialize()}var t,i,s;return t=e,s=[{key:"addHook",value:function(t,i){e.hooks[t]=this.hooks[t]||[],e.hooks[t].push(i)}},{key:"removeHook",value:function(t,i){if(void 0===e.hooks[t])return!1;const s=e.hooks[t].indexOf(i);return-1!==s&&(e.hooks[t].splice(s,1),!0)}}],(i=[{key:"duration",value:function(){return this._duration||this.videoElement.duration||0}},{key:"seekable",value:function(){if(this.hls.media){if(!this.isLive)return this.vjs.createTimeRanges(0,this.hls.media.duration);const e=Math.round(this.hls.media.duration-this.dvrDuration),t=Math.round(this.hls.media.duration-this.edgeMargin);return this.vjs.createTimeRanges(e,t)}return this.vjs.createTimeRanges()}},{key:"dispose",value:function(){this.videoElement.removeEventListener("play",this.handlers.play),this.videoElement.removeEventListener("playing",this.handlers.playing),this.player.textTracks().removeEventListener("change",this.handlers.textTracksChange),this.uiTextTrackHandled=!1,this.hls.destroy(),this.handlers=null}},{key:"_executeHooksFor",value:function(t){if(void 0!==e.hooks[t])for(let i=0;i<e.hooks[t].length;i++)e.hooks[t][i](this.player,this.hls)}},{key:"_handleMediaError",value:function(e){return 1===this.errorCounts[l.ErrorTypes.MEDIA_ERROR]?(console.info("trying to recover media error"),void this.hls.recoverMediaError()):2===this.errorCounts[l.ErrorTypes.MEDIA_ERROR]?(console.info("2nd try to recover media error (by swapping audio codec"),this.hls.swapAudioCodec(),void this.hls.recoverMediaError()):this.errorCounts[l.ErrorTypes.MEDIA_ERROR]>2?(console.info("bubbling media error up to VIDEOJS"),void this.hls.recoverMediaError()):void 0}},{key:"_handleNotFatalError",value:function(e){this.tech.trigger("error")}},{key:"_handleNetworkError",value:function(e){if(setTimeout((()=>this.hls.startLoad()),1e3),this.errorCounts[l.ErrorTypes.NETWORK_ERROR]<=1)return console.info("trying to recover network error",e),setTimeout((()=>this.hls.startLoad()),1e3),void this.hls.once(l.Events.FRAG_LOADED,(()=>{this.errorCounts[l.ErrorTypes.NETWORK_ERROR]=0}));console.info("bubbling network error up to VIDEOJS"),this.tech.error=()=>e,this.tech.trigger("error")}},{key:"_onError",value:function(e,t){const i={message:`HLS.js error: ${t.type} - fatal: ${t.fatal} - ${t.details}`};t.fatal&&(this.errorCounts[t.type]?this.errorCounts[t.type]+=1:this.errorCounts[t.type]=1,t.type===l.ErrorTypes.NETWORK_ERROR?(i.code=2,this._handleNetworkError(i)):t.type===l.ErrorTypes.MEDIA_ERROR&&"manifestIncompatibleCodecsError"!==t.details?(i.code=3,this._handleMediaError(i)):(this.tech.error=()=>i,this.tech.trigger("error")))}},{key:"switchQuality",value:function(e){this.hls.nextLevel=e}},{key:"_levelLabel",value:function(e){return this.player.srOptions_.levelLabelHandler?this.player.srOptions_.levelLabelHandler(e):e.height?e.height+"p":e.width?Math.round(9*e.width/16)+"p":e.bitrate?e.bitrate/1e3+"kbps":0}},{key:"_relayQualityChange",value:function(e){let t,i=!0;for(let t=0;t<e.length;t++)if(!e[t]._enabled){i=!1;break}if(i)this.hls.currentLevel=-1;else{for(t=e.length-1;t>=0&&!e[t]._enabled;t--);this.hls.currentLevel=t}}},{key:"_handleQualityLevels",value:function(){if(!this.metadata)return;const e=this.player.qualityLevels&&this.player.qualityLevels();if(e)for(let t=0;t<this.metadata.levels.length;t++){const i=this.metadata.levels[t],s={id:t,width:i.width,height:i.height,bandwidth:i.bitrate,bitrate:i.bitrate,_enabled:!0},n=this;s.enabled=function(e,t){return"boolean"==typeof t&&(this[e]._enabled=t,n._relayQualityChange(this)),this[e]._enabled},e.addQualityLevel(s)}}},{key:"_notifyVideoQualities",value:function(){if(!this.metadata)return;const e=[];if(this.metadata.levels.length>1){const t={id:-1,label:"auto",selected:-1===this.hls.manualLevel};e.push(t)}this.metadata.levels.forEach(((t,i)=>{const s={id:i,selected:i===this.hls.manualLevel,label:this._levelLabel(t)};e.push(s)}));const t={qualityData:{video:e},qualitySwitchCallback:this.switchQuality.bind(this)};this.tech.trigger("loadedqualitydata",t),this.videoElement.removeEventListener("playing",this.handlers.playing)}},{key:"_updateSelectedAudioTrack",value:function(){const e=this.tech.audioTracks();for(let t=0;t<e.length;t++)if(e[t].enabled){this.hls.audioTrack=t;break}}},{key:"_onAudioTracks",value:function(){const e=this.hls.audioTracks,t=this.tech.audioTracks();if(e.length>1&&0===t.length){for(let i=0;i<e.length;i++)t.addTrack(new this.vjs.AudioTrack({id:i.toString(),kind:"alternative",label:e[i].name||e[i].lang,language:e[i].lang,enabled:i===this.hls.audioTrack}));this.handlers.audioTracksChange=this._updateSelectedAudioTrack.bind(this),t.addEventListener("change",this.handlers.audioTracksChange)}}},{key:"_getTextTrackLabel",value:function(e){return e.label?e.label:e.language}},{key:"_isSameTextTrack",value:function(e,t){return this._getTextTrackLabel(e)===this._getTextTrackLabel(t)&&e.kind===t.kind}},{key:"_updateSelectedTextTrack",value:function(){const e=this.player.textTracks();let t=null;for(let i=0;i<e.length;i++)if("showing"===e[i].mode){t=e[i];break}const i=this.videoElement.textTracks;for(let e=0;e<i.length;e++)"subtitles"!==i[e].kind&&"captions"!==i[e].kind||(i[e].mode=t&&this._isSameTextTrack(i[e],t)?"showing":"disabled")}},{key:"_startLoad",value:function(){this.hls.startLoad(-1),this.videoElement.removeEventListener("play",this.handlers.play)}},{key:"_oneLevelObjClone",value:function(e){const t={},i=Object.keys(e);for(let s=0;s<i.length;s++)t[i[s]]=e[i[s]];return t}},{key:"_filterDisplayableTextTracks",value:function(e){const t=[];for(let i=0;i<e.length;i++)"subtitles"!==e[i].kind&&"captions"!==e[i].kind||t.push(e[i]);return t}},{key:"_updateTextTrackList",value:function(){const e=this._filterDisplayableTextTracks(this.videoElement.textTracks),t=this.player.textTracks();for(let i=0;i<e.length;i++){let s=!1;for(let n=0;n<t.length;n++)if(this._isSameTextTrack(e[i],t[n])){s=!0;break}if(!s){const t=e[i];this.player.addRemoteTextTrack({kind:t.kind,label:this._getTextTrackLabel(t),language:t.language,srclang:t.language},!1)}}this._updateSelectedTextTrack(),this.uiTextTrackHandled||(this.handlers.textTracksChange=this._updateSelectedTextTrack.bind(this),t.addEventListener("change",this.handlers.textTracksChange),this.uiTextTrackHandled=!0)}},{key:"_onMetaData",value:function(e,t){this.metadata=t,this._handleQualityLevels()}},{key:"_createCueHandler",value:function(e){return{newCue:(t,i,s,n)=>{let r,a,o;const l=window.VTTCue||window.TextTrackCue;for(let h=0;h<n.rows.length;h++)if(r=n.rows[h],o="",!r.isEmpty()){for(let e=0;e<r.chars.length;e++)o+=r.chars[e].ucharj;if(a=new l(i,s,o.trim()),null!=e&&"object"==typeof e){const t=Object.keys(e);for(let i=0;i<t.length;i++)a[t[i]]=e[t[i]]}t.addCue(a),s===i&&t.addCue(new l(s+5,""))}}}}},{key:"_initHlsjs",value:function(){const e=this.tech.options_,t=this.player.srOptions_,i=t&&t.hlsjsConfig||e.hlsjsConfig;this.hlsjsConfig=i?this._oneLevelObjClone(i):{},["","auto"].includes(this.videoElement.preload)&&!this.videoElement.autoplay&&void 0===this.hlsjsConfig.autoStartLoad&&(this.hlsjsConfig.autoStartLoad=!1);const s=t&&t.captionConfig||e.captionConfig;s&&(this.hlsjsConfig.cueHandler=this._createCueHandler(s)),!1===this.hlsjsConfig.autoStartLoad&&(this.handlers.play=this._startLoad.bind(this),this.videoElement.addEventListener("play",this.handlers.play)),this.handlers.playing=this._notifyVideoQualities.bind(this),this.videoElement.addEventListener("playing",this.handlers.playing),this.hlsjsConfig.capLevelController=p,this.hls=new(h())(this.hlsjsConfig),this.player.hls=this.hls,this.hls.on(l.Events.ERROR,((e,t)=>this._onError(e,t))),this.hls.on(l.Events.AUDIO_TRACKS_UPDATED,(()=>this._onAudioTracks())),this.hls.on(l.Events.MANIFEST_PARSED,((e,t)=>this._onMetaData(e,t))),this.hls.on(l.Events.LEVEL_LOADED,((e,t)=>{this.hlsjsConfig.liveSyncDuration?this.edgeMargin=this.hlsjsConfig.liveSyncDuration:this.hlsjsConfig.liveSyncDurationCount&&(this.edgeMargin=this.hlsjsConfig.liveSyncDurationCount*t.details.targetduration),this.isLive=t.details.live,this.dvrDuration=t.details.totalduration,this._duration=this.isLive?1/0:t.details.totalduration})),this.hls.once(l.Events.FRAG_LOADED,(()=>{this.tech.trigger("loadedmetadata")})),this.hls.attachMedia(this.videoElement),this.hls.loadSource(this.source.src)}},{key:"initialize",value:function(){this._initHlsjs()}}])&&f(t.prototype,i),s&&f(t,s),Object.defineProperty(t,"prototype",{writable:!1}),e}();function y(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function k(e,t){return k=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},k(e,t)}function T(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,s=b(e);if(t){var n=b(this).constructor;i=Reflect.construct(s,arguments,n)}else i=s.apply(this,arguments);return E(this,i)}}function E(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function b(e){return b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},b(e)}var m;v.hooks={},((m=n()).registerPlugin||m.plugin)("hlsjs",g),function(e){if(!h().isSupported())return void console.warn("Hls.js is not supported in this browser!");const t=e.getTech("Html5");t?(t.registerSourceHandler({canHandleSource:function(e){return/^application\/x-mpegURL|application\/vnd\.apple\.mpegurl$/i.test(e.type)?"probably":/\.m3u8/i.test(e.src)?"maybe":""},handleSource:function(t,i){return i.hlsProvider&&i.hlsProvider.dispose(),i.hlsProvider=new v(e,t,i),i.hlsProvider}},0),e.Html5Hlsjs=v):console.error("Not supported version if video.js")}(n());let _=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&k(e,t)}(u,e);var t,i,s,h=T(u);function u(e,t){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(i=h.call(this,e)).CONSTANTS={INFO_SCHEDULER:1e3},i.statsP2PBytes={pendingDownload:[],pendingUpload:[],numPeers:0,totalDownload:0,totalUpload:0},i.statsHTTPBytes={pendingDownload:[],pendingUpload:[],totalDownload:0,totalUpload:0},i.options=t,(0,r.initVideoJsContribHlsJsPlayer)(e),t&&(i.startTime=(0,o.h8)(t.startTime),e.src({type:t.type,src:t.src})),e.ready((()=>{i.initializeCore(),i.hlsjs=e.hls,n().Html5Hlsjs&&t&&i.initializePlugin()})),i}return t=u,(i=[{key:"dispose",value:function(){this.hlsjs&&this.hlsjs.destroy(),this.p2pEngine&&this.p2pEngine.destroy(),clearInterval(this.networkInfoInterval)}},{key:"getHLSJS",value:function(){return this.hlsjs}},{key:"initializeCore",value:function(){this.player.one("play",(()=>{this.player.addClass("vjs-has-big-play-button-clicked")})),this.player.one("canplay",(()=>{this.startTime&&this.player.currentTime(this.startTime)}))}},{key:"initializePlugin",value:function(){(0,r.initHlsJsPlayer)(this.hlsjs);const e=this.player.tech(!0).options_;this.p2pEngine=e.hlsjsConfig.loader.getEngine(),this.hlsjs.on(l.Events.LEVEL_SWITCHING,((e,t)=>{this.trigger("resolutionChange",{auto:this.hlsjs.autoLevelEnabled,resolutionId:t.height})})),this.p2pEngine.on(a.zW.SegmentError,((e,t)=>{this.options.redundancyUrlManager.removeBySegmentUrl(e.requestUrl)})),this.statsP2PBytes.numPeers=1+this.options.redundancyUrlManager.countBaseUrls(),this.runStats()}},{key:"runStats",value:function(){this.p2pEngine.on(a.zW.PieceBytesDownloaded,((e,t,i)=>{const s="p2p"===e?this.statsP2PBytes:this.statsHTTPBytes;s.pendingDownload.push(i),s.totalDownload+=i})),this.p2pEngine.on(a.zW.PieceBytesUploaded,((e,t,i)=>{const s="p2p"===e?this.statsP2PBytes:this.statsHTTPBytes;s.pendingUpload.push(i),s.totalUpload+=i})),this.p2pEngine.on(a.zW.PeerConnect,(()=>this.statsP2PBytes.numPeers++)),this.p2pEngine.on(a.zW.PeerClose,(()=>this.statsP2PBytes.numPeers--)),this.networkInfoInterval=setInterval((()=>{const e=this.arraySum(this.statsP2PBytes.pendingDownload),t=this.arraySum(this.statsP2PBytes.pendingUpload),i=this.arraySum(this.statsHTTPBytes.pendingDownload),s=this.arraySum(this.statsHTTPBytes.pendingUpload);return this.statsP2PBytes.pendingDownload=[],this.statsP2PBytes.pendingUpload=[],this.statsHTTPBytes.pendingDownload=[],this.statsHTTPBytes.pendingUpload=[],this.player.trigger("p2pInfo",{source:"p2p-media-loader",http:{downloadSpeed:i,uploadSpeed:s,downloaded:this.statsHTTPBytes.totalDownload,uploaded:this.statsHTTPBytes.totalUpload},p2p:{downloadSpeed:e,uploadSpeed:t,numPeers:this.statsP2PBytes.numPeers,downloaded:this.statsP2PBytes.totalDownload,uploaded:this.statsP2PBytes.totalUpload}})}),this.CONSTANTS.INFO_SCHEDULER)}},{key:"arraySum",value:function(e){return e.reduce(((e,t)=>e+t),0)}}])&&y(t.prototype,i),s&&y(t,s),Object.defineProperty(t,"prototype",{writable:!1}),u}(n().getPlugin("plugin"));n().registerPlugin("p2pMediaLoader",_)}}]);
//# sourceMappingURL=53.chunk.js.map