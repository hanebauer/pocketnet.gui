/*! For license information please see 795.chunk.js.LICENSE.txt */
(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[795],{3819:(e,t,n)=>{"use strict";var r;n.d(t,{zW:()=>r,ou:()=>Pe}),function(e){e.SegmentLoaded="segment_loaded",e.SegmentError="segment_error",e.SegmentSize="segment_size",e.SegmentAbort="segment_abort",e.SegmentStartLoad="segment_start_load",e.PeerConnect="peer_connect",e.PeerClose="peer_close",e.PieceBytesDownloaded="piece_bytes_downloaded",e.PieceBytesUploaded="piece_bytes_uploaded"}(r||(r={}));var o=n(649),s=n(7201),i=n.n(s),a=n(5101),l=n(4487),d=n.n(l);n(9739);function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=S(e);if(t){var o=S(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return p(this,n)}}function p(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return f(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(){return h="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=y(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(arguments.length<3?e:n):o.value}},h.apply(this,arguments)}function y(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=S(e)););return e}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}let w=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}(s,e);var t,n,r,o=m(s);function s(){var e,t,n;return g(this,s),(n=o.apply(this,arguments)).on=(t,r)=>h((e=f(n),S(s.prototype)),"on",e).call(e,t,r),n.emit=function(e){for(var r,o=arguments.length,i=new Array(o>1?o-1:0),a=1;a<o;a++)i[a-1]=arguments[a];return(r=h((t=f(n),S(s.prototype)),"emit",t)).call.apply(r,[t,e].concat(i))},n}return t=s,n&&u(t.prototype,n),r&&u(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}(a.EventEmitter);function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t&&b(e.prototype,t),n&&b(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function P(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function R(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&M(e,t)}function M(e,t){return M=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},M(e,t)}function I(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=C(e);if(t){var o=C(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return T(this,n)}}function T(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return O(e)}function O(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function C(e){return C=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},C(e)}let q=function(e){R(n,e);var t=I(n);function n(e){var r;return P(this,n),(r=t.call(this)).settings=e,r.fetchRequests=new Map,r.failedSegments=new Map,r.debug=i()("p2pml:http-media-manager"),r.fetch=function(){return fetch.apply(void 0,arguments)},r.download=(e,t)=>{if(r.isDownloading(e))return;console.log("download"),r.cleanTimedOutFailedSegments(),r.emit("segment-start-load",e);const n=r.buildSegmentUrl(e),o=new AbortController;r.fetchRequests.set(e.id,{fetchAbort:o,segment:e,initialPriority:e.priority,segmentUrl:n}),r.debug("http segment download",n),e.requestUrl=n;const s=new Headers;if(e.range)s.append("Range",e.range);else if(void 0!==t&&r.settings.httpUseRanges){let e=0;for(const n of t)e+=n.byteLength;s.append("Range",`bytes=${e}-`),r.debug("continue download from",e)}else t=void 0;const i=o.signal,a=r.fetch(n,{headers:s,signal:i});r.setupFetchEvents(a,e,t).catch((t=>{if("AbortError"!==t.name)if("network error"!==t.message)if("Failed to fetch"!==t.message);else{r.debug("Segment fetch failed",e);const t=Error("FETCH_FAILED");r.segmentFailure(e,t,e.url)}else{r.debug("Segment loading is unavailable. No internet",e);const t=Error("NETWORK_ERROR");r.segmentFailure(e,t,e.url)}else r.debug("Segment loading was aborted by user",e)})),r.fetchRequests.set(e.id,{request:a,fetchAbort:o,segment:e,initialPriority:e.priority,segmentUrl:n})},r.updatePriority=e=>{const t=r.fetchRequests.get(e.id);if(!t)throw new Error("Cannot update priority of not downloaded segment "+e.id);e.priority<=r.settings.requiredSegmentsPriority&&t.initialPriority>r.settings.requiredSegmentsPriority&&t.segmentUrl!==r.buildSegmentUrl(e)&&(r.debug("aborting http segment abort because the segment is now in a high priority",e.id),r.abort(e),r.download(e))},r.abort=e=>{const t=r.fetchRequests.get(e.id);console.log("abort command"),t&&(console.log("ABORT"),t.fetchAbort.abort(),r.fetchRequests.delete(e.id),r.debug("http segment abort",e.id))},r.isDownloading=e=>r.fetchRequests.has(e.id),r.isFailed=e=>{const t=r.failedSegments.get(e.id);return void 0!==t&&t>r.now()},r.getActiveDownloads=()=>r.fetchRequests,r.getActiveDownloadsCount=()=>r.fetchRequests.size,r.destroy=()=>{r.fetchRequests.forEach((e=>e.fetchAbort.abort())),r.fetchRequests.clear()},r.setupFetchEvents=(e,t,n)=>(0,o.mG)(O(r),void 0,void 0,(function*(){const r=yield e,o=r.body.getReader(),s=r.headers.get("Content-Length"),i=Number.parseFloat(s),a=new Uint8Array(i);let l,d=0;if(Array.isArray(n)&&206===r.status)for(const e of n){const t=new Uint8Array(e);a.set(t,d),d=e.byteLength}for(;!(l=yield o.read()).done;){const e=l.value;a.set(e,d),d+=e.length,this.emit("bytes-downloaded",t,e.length),i&&this.emit("segment-size",t,i)}if(r.status<200||r.status>=300){const e=Error(`Segment failure with HTTP code ${r.status}`);this.segmentFailure(t,e,r.url)}else yield this.segmentDownloadFinished(t,a.buffer,r)})),r.segmentDownloadFinished=(e,t,n)=>(0,o.mG)(O(r),void 0,void 0,(function*(){if(e.responseUrl=n.url,this.settings.segmentValidator)try{yield this.settings.segmentValidator(Object.assign(Object.assign({},e),{data:t}),"http")}catch(t){return this.debug("segment validator failed",t),void this.segmentFailure(e,t,n.url)}this.fetchRequests.delete(e.id),this.emit("segment-loaded",e,t)})),r.segmentFailure=(e,t,n)=>{e.responseUrl=n,r.fetchRequests.delete(e.id),r.failedSegments.set(e.id,r.now()+r.settings.httpFailedSegmentTimeout),r.emit("segment-error",e,t)},r.cleanTimedOutFailedSegments=()=>{const e=r.now(),t=[];r.failedSegments.forEach(((n,r)=>{n<e&&t.push(r)})),t.forEach((e=>r.failedSegments.delete(e)))},r.now=()=>performance.now(),e.localTransport&&(r.fetch=e.localTransport),r}return v(n,[{key:"buildSegmentUrl",value:function(e){return this.settings.segmentUrlBuilder?this.settings.segmentUrlBuilder(e):e.url}}]),n}(function(e){R(n,e);var t=I(n);function n(){return P(this,n),t.apply(this,arguments)}return v(n)}(w));var D,k,E=n(3101),j=n.n(E),A=n(8823),B=n(6029),_=n.n(B);function L(e,t){return L=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},L(e,t)}function U(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Q(e);if(t){var o=Q(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return x(this,n)}}function x(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return z(e)}function z(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Q(e){return Q=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Q(e)}function G(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function H(e,t,n){return t&&G(e.prototype,t),n&&G(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function F(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e){e[e.SegmentData=0]="SegmentData",e[e.SegmentAbsent=1]="SegmentAbsent",e[e.SegmentsMap=2]="SegmentsMap",e[e.SegmentRequest=3]="SegmentRequest",e[e.CancelSegmentRequest=4]="CancelSegmentRequest"}(D||(D={})),function(e){e[e.Loaded=0]="Loaded",e[e.LoadingByHttp=1]="LoadingByHttp"}(k||(k={}));let W=H((function e(t,n){F(this,e),this.id=t,this.size=n,this.bytesDownloaded=0,this.pieces=[]})),$=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&L(e,t)}(n,e);var t=U(n);function n(e,r){var o;return F(this,n),(o=t.call(this)).peer=e,o.settings=r,o.remoteAddress="",o.downloadingSegmentId=null,o.downloadingSegment=null,o.segmentsMap=new Map,o.debug=i()("p2pml:media-peer"),o.timer=null,o.onPeerConnect=()=>{console.log("this.peer.remoteAddress",o.id,o.peer.remoteAddress),o.debug("peer connect",o.id,z(o)),o.remoteAddress=o.peer.remoteAddress,o.emit("connect",z(o))},o.onPeerClose=()=>{console.log("this.peer.close",o.id),o.debug("peer close",o.id,z(o)),o.terminateSegmentRequest(),o.emit("close",z(o))},o.onPeerError=e=>{console.error(e),o.debug("peer error",o.id,e,z(o))},o.receiveSegmentPiece=e=>{if(!o.downloadingSegment)return void o.debug("peer segment not requested",o.id,z(o));o.downloadingSegment.bytesDownloaded+=e.byteLength,o.downloadingSegment.pieces.push(e);const t=o.downloadingSegment.id;if(o.emit("bytes-downloaded",z(o),t,e.byteLength),o.downloadingSegment.bytesDownloaded===o.downloadingSegment.size){const e=new Uint8Array(o.downloadingSegment.size);let n=0;for(const t of o.downloadingSegment.pieces)e.set(new Uint8Array(t),n),n+=t.byteLength;o.debug("peer segment download done",o.id,t,z(o)),o.terminateSegmentRequest(),o.emit("segment-loaded",z(o),t,e.buffer)}else o.downloadingSegment.bytesDownloaded>o.downloadingSegment.size&&(o.debug("peer segment download bytes mismatch",o.id,t,z(o)),o.terminateSegmentRequest(),o.emit("segment-error",z(o),t,"Too many bytes received for segment"))},o.getJsonCommand=e=>{const t=new Uint8Array(e);if(123===t[0]&&34===t[1]&&125===t[e.byteLength-1])try{return JSON.parse((new TextDecoder).decode(e))}catch(e){return null}return null},o.onPeerData=e=>{const t=o.getJsonCommand(e);if(console.log("command",t),null!==t){if(o.downloadingSegment){o.debug("peer segment download is interrupted by a command",o.id,z(o));const e=o.downloadingSegment.id;return o.terminateSegmentRequest(),void o.emit("segment-error",z(o),e,"Segment download is interrupted by a command")}switch(o.debug("peer receive command",o.id,t,z(o)),t.c){case D.SegmentsMap:o.segmentsMap=o.createSegmentsMap(t.m),o.emit("data-updated");break;case D.SegmentRequest:o.emit("segment-request",z(o),t.i);break;case D.SegmentData:o.downloadingSegmentId&&o.downloadingSegmentId===t.i&&"number"==typeof t.s&&t.s>=0&&(o.downloadingSegment=new W(t.i,t.s),o.emit("segment-start-load",o.downloadingSegment.id),o.emit("segment-size",o.downloadingSegment.id,o.downloadingSegment.size),o.cancelResponseTimeoutTimer());break;case D.SegmentAbsent:o.downloadingSegmentId&&o.downloadingSegmentId===t.i&&(o.terminateSegmentRequest(),o.segmentsMap.delete(t.i),o.emit("segment-absent",z(o),t.i));case D.CancelSegmentRequest:}}else o.receiveSegmentPiece(e)},o.createSegmentsMap=e=>{if(!(e instanceof Object))return new Map;const t=new Map;for(const n of Object.keys(e)){const r=e[n];if(!(r instanceof Array&&2===r.length&&"string"==typeof r[0]&&r[1]instanceof Array))return new Map;const o=r[0].split("|"),s=r[1];if(o.length!==s.length)return new Map;for(let e=0;e<o.length;e++){const r=s[e];if("number"!=typeof r||void 0===k[r])return new Map;t.set(`${n}+${o[e]}`,r)}}return t},o.sendCommand=e=>{o.debug("peer send command",o.id,e,z(o)),o.peer.write(JSON.stringify(e))},o.destroy=()=>{console.log("___DESTROY"),o.debug("peer destroy",o.id,z(o)),o.terminateSegmentRequest(),o.peer.destroy()},o.getDownloadingSegmentId=()=>o.downloadingSegmentId,o.getSegmentsMap=()=>o.segmentsMap,o.sendSegmentsMap=e=>{o.sendCommand({c:D.SegmentsMap,m:e})},o.sendSegmentData=(e,t)=>{o.sendCommand({c:D.SegmentData,i:e,s:t.byteLength});let n=t.byteLength;for(;n>0;){const e=n>=o.settings.webRtcMaxMessageSize?o.settings.webRtcMaxMessageSize:n,r=A.Buffer.from(t,t.byteLength-n,e);o.peer.write(r),n-=e}o.emit("bytes-uploaded",z(o),e,t.byteLength)},o.sendSegmentAbsent=e=>{o.sendCommand({c:D.SegmentAbsent,i:e})},o.requestSegment=e=>{if(o.downloadingSegmentId)throw new Error("A segment is already downloading: "+o.downloadingSegmentId);o.sendCommand({c:D.SegmentRequest,i:e}),o.downloadingSegmentId=e,o.runResponseTimeoutTimer()},o.cancelSegmentRequest=()=>{let e;if(o.downloadingSegmentId){const t=o.downloadingSegmentId;e=o.downloadingSegment?o.downloadingSegment.pieces:void 0,o.terminateSegmentRequest(),o.sendCommand({c:D.CancelSegmentRequest,i:t})}return e},o.runResponseTimeoutTimer=()=>{o.timer=setTimeout((()=>{if(o.timer=null,!o.downloadingSegmentId)return;const e=o.downloadingSegmentId;o.cancelSegmentRequest(),o.emit("segment-timeout",z(o),e)}),o.settings.p2pSegmentDownloadTimeout)},o.cancelResponseTimeoutTimer=()=>{o.timer&&(clearTimeout(o.timer),o.timer=null)},o.terminateSegmentRequest=()=>{o.downloadingSegmentId=null,o.downloadingSegment=null,o.cancelResponseTimeoutTimer()},o.peer.on("connect",o.onPeerConnect),o.peer.on("close",o.onPeerClose),o.peer.on("error",o.onPeerError),o.peer.on("data",o.onPeerData),o.id=e.id,o}return H(n)}(w);function J(e,t){return J=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},J(e,t)}function V(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Y(e);if(t){var o=Y(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return N(this,n)}}function N(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return K(e)}function K(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Y(e){return Y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Y(e)}function X(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Z(e,t,n){return t&&X(e.prototype,t),n&&X(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function ee(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}const te=`-WW${"0.6.2".replace(/\d*./g,(e=>("0"+parseInt(e,10)%100).slice(-2))).slice(0,4)}-`;let ne=Z((function e(t,n){ee(this,e),this.peerId=t,this.segment=n}));let re=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&J(e,t)}(n,e);var t=V(n);function n(e,r){var s;return ee(this,n),(s=t.call(this)).segmentsStorage=e,s.settings=r,s.trackerClient=null,s.peers=new Map,s.peerCandidates=new Map,s.peerSegmentRequests=new Map,s.streamSwarmId=null,s.debug=i()("p2pml:p2p-media-manager"),s.pendingTrackerClient=null,s.getPeers=()=>s.peers,s.getPeerId=()=>A.Buffer.from(s.peerId).toString("hex"),s.setStreamSwarmId=(e,t)=>{if(s.streamSwarmId===e)return;s.destroy(!0),s.streamSwarmId=e,s.masterSwarmId=t,s.debug("stream swarm ID",s.streamSwarmId),s.pendingTrackerClient={isDestroyed:!1};const n=s.pendingTrackerClient,r=(new(_())).update(`2${s.streamSwarmId}`).digest();n.isDestroyed?null!==s.trackerClient&&(s.trackerClient.destroy(),s.trackerClient=null):(s.pendingTrackerClient=null,s.createClient(r))},s.createClient=e=>{if(!s.settings.useP2P)return;const t={infoHash:A.Buffer.from(e,0,20),peerId:A.Buffer.from(s.peerId,0,20),announce:s.settings.trackerAnnounce,rtcConfig:s.settings.rtcConfig,port:6881,getAnnounceOpts:()=>({numwant:s.settings.peerRequestsPerAnnounce})};let n=s.trackerClient;s.trackerClient=new(j())(t),s.trackerClient.on("error",s.onTrackerError),s.trackerClient.on("warning",s.onTrackerWarning),s.trackerClient.on("update",s.onTrackerUpdate),s.trackerClient.on("peer",s.onTrackerPeer),s.trackerClient.start(),null!==n&&(n.destroy(),n=null)},s.onTrackerError=e=>{console.error(e),s.debug("tracker error",e)},s.onTrackerWarning=e=>{console.error(e),s.debug("tracker warning",e)},s.onTrackerUpdate=e=>{s.debug("tracker update",e),s.emit("tracker-update",e)},s.onTrackerPeer=e=>{if(s.debug("tracker peer",e.id,e),console.log("trackerPeer",e),s.peers.has(e.id))return s.debug("tracker peer already connected",e.id,e),void e.destroy();const t=new $(e,s.settings);t.on("connect",s.onPeerConnect),t.on("close",s.onPeerClose),t.on("data-updated",s.onPeerDataUpdated),t.on("segment-request",s.onSegmentRequest),t.on("segment-loaded",s.onSegmentLoaded),t.on("segment-absent",s.onSegmentAbsent),t.on("segment-error",s.onSegmentError),t.on("segment-size",s.onSegmentSize),t.on("segment-start-load",s.onSegmentStartLoad),t.on("segment-timeout",s.onSegmentTimeout),t.on("bytes-downloaded",s.onPieceBytesDownloaded),t.on("bytes-uploaded",s.onPieceBytesUploaded);let n=s.peerCandidates.get(t.id);n||(n=[],s.peerCandidates.set(t.id,n)),n.push(t),console.log("peerCandidatesById",n)},s.download=e=>{if(s.isDownloading(e))return!1;const t=[];for(const n of s.peers.values())null===n.getDownloadingSegmentId()&&n.getSegmentsMap().get(e.id)===k.Loaded&&t.push(n);if(0===t.length)return!1;const n=t[Math.floor(Math.random()*t.length)];return n.requestSegment(e.id),s.peerSegmentRequests.set(e.id,new ne(n.id,e)),!0},s.abort=e=>{let t;const n=s.peerSegmentRequests.get(e.id);if(n){const r=s.peers.get(n.peerId);r&&(console.log("ABOOOORT"),t=r.cancelSegmentRequest()),s.peerSegmentRequests.delete(e.id)}return t},s.isDownloading=e=>s.peerSegmentRequests.has(e.id),s.getActiveDownloadsCount=()=>s.peerSegmentRequests.size,s.destroy=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];s.streamSwarmId=null,s.trackerClient&&(s.trackerClient.stop(),e?(s.trackerClient.removeAllListeners("error"),s.trackerClient.removeAllListeners("warning"),s.trackerClient.removeAllListeners("update"),s.trackerClient.removeAllListeners("peer")):(s.trackerClient.destroy(),s.trackerClient=null)),s.pendingTrackerClient&&(s.pendingTrackerClient.isDestroyed=!0,s.pendingTrackerClient=null),s.peers.forEach((e=>e.destroy())),s.peers.clear(),s.peerSegmentRequests.clear();for(const e of s.peerCandidates.values())for(const t of e)t.destroy();s.peerCandidates.clear()},s.sendSegmentsMapToAll=e=>{s.peers.forEach((t=>t.sendSegmentsMap(e)))},s.sendSegmentsMap=(e,t)=>{const n=s.peers.get(e);n&&n.sendSegmentsMap(t)},s.getOverallSegmentsMap=()=>{const e=new Map;for(const t of s.peers.values())for(const[n,r]of t.getSegmentsMap())r===k.Loaded?e.set(n,k.Loaded):e.get(n)||e.set(n,k.LoadingByHttp);return e},s.onPieceBytesDownloaded=(e,t,n)=>{const r=s.peerSegmentRequests.get(t);r&&s.emit("bytes-downloaded",r.segment,n,e.id)},s.onPieceBytesUploaded=(e,t,n)=>{const r=s.peerSegmentRequests.get(t);s.emit("bytes-uploaded",r?r.segment:null,n,e.id)},s.onPeerConnect=e=>{if(s.peers.get(e.id))return s.debug("tracker peer already connected (in peer connect)",e.id,e),void e.destroy();s.peers.set(e.id,e);const t=s.peerCandidates.get(e.id);if(t){for(const n of t)n!==e&&n.destroy();s.peerCandidates.delete(e.id)}s.emit("peer-connected",{id:e.id,remoteAddress:e.remoteAddress})},s.onPeerClose=e=>{if(console.log("onPeerClose",e),s.peers.get(e.id)!==e){const t=s.peerCandidates.get(e.id);if(!t)return;const n=t.indexOf(e);return-1!==n&&t.splice(n,1),void(0===t.length&&s.peerCandidates.delete(e.id))}for(const[t,n]of s.peerSegmentRequests)n.peerId===e.id&&s.peerSegmentRequests.delete(t);s.peers.delete(e.id),s.emit("peer-data-updated"),s.emit("peer-closed",e.id)},s.onPeerDataUpdated=()=>{s.emit("peer-data-updated")},s.onSegmentRequest=(e,t)=>(0,o.mG)(K(s),void 0,void 0,(function*(){if(void 0===this.masterSwarmId)return;const n=yield this.segmentsStorage.getSegment(t,this.masterSwarmId);n&&n.data?e.sendSegmentData(t,n.data):e.sendSegmentAbsent(t)})),s.onSegmentLoaded=(e,t,n)=>(0,o.mG)(K(s),void 0,void 0,(function*(){const r=this.peerSegmentRequests.get(t);if(!r)return;const o=r.segment;if(this.settings.segmentValidator)try{yield this.settings.segmentValidator(Object.assign(Object.assign({},o),{data:n}),"p2p",e.id)}catch(n){return this.debug("segment validator failed",n),this.peerSegmentRequests.delete(t),this.emit("segment-error",o,n,e.id),void this.onPeerClose(e)}this.peerSegmentRequests.delete(t),this.emit("segment-loaded",o,n,e.id)})),s.onSegmentAbsent=(e,t)=>{s.peerSegmentRequests.delete(t),s.emit("peer-data-updated")},s.onSegmentError=(e,t,n)=>{const r=s.peerSegmentRequests.get(t);r&&(s.peerSegmentRequests.delete(t),s.emit("segment-error",r.segment,n,e.id))},s.onSegmentSize=(e,t)=>{const n=s.peerSegmentRequests.get(e);n&&s.emit("segment-size",n.segment,t)},s.onSegmentStartLoad=(e,t)=>{const n=s.peerSegmentRequests.get(e);n&&s.emit("segment-start-load",n.segment,t)},s.onSegmentTimeout=(e,t)=>{const n=s.peerSegmentRequests.get(t);n&&(s.peerSegmentRequests.delete(t),e.destroy(),s.peers.delete(n.peerId)&&s.emit("peer-data-updated"))},s.peerId=r.useP2P?function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t=te;for(let n=0;n<20-te.length;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return(new TextEncoder).encode(t).buffer}():new ArrayBuffer(0),s.debug.enabled&&s.debug("peer ID",s.getPeerId(),(new TextDecoder).decode(s.peerId)),s}return Z(n)}(w);function oe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function se(e,t,n){return t&&oe(e.prototype,t),n&&oe(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function ie(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}const ae=i()("p2pml:bandwidth-approximator"),le=2e3;let de=se((function e(t,n){ie(this,e),this.value=t,this.timeStamp=n})),ue=se((function e(){ie(this,e),this.lastBytes=[],this.currentBytesSum=0,this.lastBandwidth=[],this.addBytes=(e,t)=>{for(ae("Add %d bytes.",e),this.lastBytes.push(new de(e,t)),this.currentBytesSum+=e;t-this.lastBytes[0].timeStamp>le;)this.currentBytesSum-=this.lastBytes.shift().value;const n=Math.min(le,t);this.lastBandwidth.push(new de(this.currentBytesSum/n,t))},this.getBandwidth=e=>{for(;0!==this.lastBandwidth.length&&e-this.lastBandwidth[0].timeStamp>4e4;)this.lastBandwidth.shift();let t=0;for(const e of this.lastBandwidth)e.value>t&&(t=e.value);return ae("Max bandwidth: %d.",t),t},this.getSmoothInterval=()=>le,this.getMeasureInterval=()=>4e4}));function ge(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ce(e,t,n){return t&&ge(e.prototype,t),n&&ge(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}let me=ce((function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.settings=t,this.cache=new Map,this.storeSegment=e=>(0,o.mG)(this,void 0,void 0,(function*(){this.cache.set(e.id,{segment:e,lastAccessed:performance.now()})})),this.getSegmentsMap=()=>(0,o.mG)(this,void 0,void 0,(function*(){return this.cache})),this.getSegment=e=>(0,o.mG)(this,void 0,void 0,(function*(){const t=this.cache.get(e);if(void 0!==t)return t.lastAccessed=performance.now(),t.segment})),this.hasSegment=e=>(0,o.mG)(this,void 0,void 0,(function*(){return this.cache.has(e)})),this.clean=(e,t)=>(0,o.mG)(this,void 0,void 0,(function*(){const e=[],n=[],r=performance.now();for(const t of this.cache.values())r-t.lastAccessed>this.settings.cachedSegmentExpiration?e.push(t.segment.id):n.push(t);let o=n.length-this.settings.cachedSegmentsCount;if(o>0){n.sort(((e,t)=>e.lastAccessed-t.lastAccessed));for(const r of n)if((void 0===t||!t(r.segment.id))&&(e.push(r.segment.id),o--,0===o))break}return e.forEach((e=>this.cache.delete(e))),e.length>0})),this.destroy=()=>(0,o.mG)(this,void 0,void 0,(function*(){this.cache.clear()}))}));function pe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function fe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function he(e,t){return he=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},he(e,t)}function ye(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=be(e);if(t){var o=be(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return Se(this,n)}}function Se(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return we(e)}function we(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function be(e){return be=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},be(e)}const ve={cachedSegmentExpiration:6e5,cachedSegmentsCount:1e3,useP2P:!0,consumeOnly:!1,requiredSegmentsPriority:3,simultaneousHttpDownloads:2,httpDownloadProbability:.06,httpDownloadProbabilityInterval:1e3,httpDownloadProbabilitySkipIfNoPeers:!1,httpFailedSegmentTimeout:1500,httpDownloadMaxPriority:20,httpDownloadInitialTimeout:0,httpDownloadInitialTimeoutPerSegment:100,httpUseRanges:!1,simultaneousP2PDownloads:20,p2pDownloadMaxPriority:50,p2pSegmentDownloadTimeout:6e4,webRtcMaxMessageSize:65535,trackerAnnounce:["wss://tracker.novage.com.ua","wss://tracker.openwebtorrent.com"],peerRequestsPerAnnounce:10,rtcConfig:d().config};let Pe=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&he(e,t)}(l,e);var t,n,s,a=ye(l);function l(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};fe(this,l),(e=a.call(this)).debug=i()("p2pml:hybrid-loader"),e.debugSegments=i()("p2pml:hybrid-loader-segments"),e.segmentsQueue=[],e.bandwidthApproximator=new ue,e.httpDownloadInitialTimeoutTimestamp=-1/0,e.createHttpManager=()=>new q(e.settings),e.createP2PManager=()=>new re(e.segmentsStorage,e.settings),e.load=(t,n)=>(0,o.mG)(we(e),void 0,void 0,(function*(){void 0===this.httpRandomDownloadInterval&&(this.httpRandomDownloadInterval=setInterval(this.downloadRandomSegmentOverHttp,this.settings.httpDownloadProbabilityInterval),this.settings.httpDownloadInitialTimeout>0&&this.settings.httpDownloadInitialTimeoutPerSegment>0&&(this.debugSegments("enable initial HTTP download timeout",this.settings.httpDownloadInitialTimeout,"per segment",this.settings.httpDownloadInitialTimeoutPerSegment),this.httpDownloadInitialTimeoutTimestamp=this.now(),setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment+100))),t.length>0&&(this.masterSwarmId=t[0].masterSwarmId),void 0!==this.masterSwarmId&&this.p2pManager.setStreamSwarmId(n,this.masterSwarmId),this.debug("load segments");let e=!1;console.log("LOAD SEGMENTS",this.segmentsQueue.length);for(const n of this.segmentsQueue)t.find((e=>e.id===n.id))||(this.debug("remove segment",n.url),console.log("REMOVE SEGMENTS"),this.httpManager.isDownloading(n)?(e=!0,this.httpManager.abort(n)):this.p2pManager.abort(n),this.emit(r.SegmentAbort,n));if(this.debug.enabled)for(const e of t)this.segmentsQueue.find((t=>t.id===e.id))||this.debug("add segment",e.url);if(this.segmentsQueue=t,void 0===this.masterSwarmId)return;let o=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);e=this.processSegmentsQueue(o)||e,(yield this.cleanSegmentsStorage())&&(o=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId),e=!0),e&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(o))})),e.getSegment=t=>(0,o.mG)(we(e),void 0,void 0,(function*(){return void 0===this.masterSwarmId?void 0:this.segmentsStorage.getSegment(t,this.masterSwarmId)})),e.getSettings=()=>e.settings,e.getDetails=()=>({peerId:e.p2pManager.getPeerId()}),e.getBandwidthEstimate=()=>e.bandwidthApproximator.getBandwidth(e.now()),e.destroy=()=>(0,o.mG)(we(e),void 0,void 0,(function*(){void 0!==this.httpRandomDownloadInterval&&(clearInterval(this.httpRandomDownloadInterval),this.httpRandomDownloadInterval=void 0),this.httpDownloadInitialTimeoutTimestamp=-1/0,this.segmentsQueue=[],this.httpManager.destroy(),this.p2pManager.destroy(),this.masterSwarmId=void 0,yield this.segmentsStorage.destroy()})),e.processInitialSegmentTimeout=()=>(0,o.mG)(we(e),void 0,void 0,(function*(){if(void 0!==this.httpRandomDownloadInterval){if(void 0!==this.masterSwarmId){const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}this.httpDownloadInitialTimeoutTimestamp!==-1/0&&setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment)}})),e.processSegmentsQueue=t=>{if(e.debugSegments("process segments queue. priority",e.segmentsQueue.length>0?e.segmentsQueue[0].priority:0),void 0===e.masterSwarmId||0===e.segmentsQueue.length)return!1;let n,r=!1,o=!0;if(e.httpDownloadInitialTimeoutTimestamp!==-1/0){let n;for(const r of e.segmentsQueue)if(!t.has(r.id)){n=r.priority;break}const r=e.now()-e.httpDownloadInitialTimeoutTimestamp;o=r>=e.settings.httpDownloadInitialTimeout||void 0!==n&&r>e.settings.httpDownloadInitialTimeoutPerSegment&&n<=0,o&&(e.debugSegments("cancel initial HTTP download timeout - timed out"),e.httpDownloadInitialTimeoutTimestamp=-1/0)}for(let s=0;s<e.segmentsQueue.length;s++){const i=e.segmentsQueue[s];if(!t.has(i.id))if(e.httpManager.isDownloading(i))e.httpManager.updatePriority(i);else{if(i.priority<=e.settings.requiredSegmentsPriority&&o&&!e.httpManager.isFailed(i)){if(e.httpManager.getActiveDownloadsCount()>=e.settings.simultaneousHttpDownloads)for(let t=e.segmentsQueue.length-1;t>s;t--){const n=e.segmentsQueue[t];if(e.httpManager.isDownloading(n)){e.debugSegments("cancel HTTP download",n.priority,n.url),e.httpManager.abort(n);break}}if(e.httpManager.getActiveDownloadsCount()<e.settings.simultaneousHttpDownloads){const t=e.p2pManager.abort(i);e.httpManager.download(i,t),e.debugSegments("HTTP download (priority)",i.priority,i.url),r=!0;continue}}if(!e.p2pManager.isDownloading(i))if(i.priority<=e.settings.requiredSegmentsPriority){if(n=n||e.p2pManager.getOverallSegmentsMap(),n.get(i.id)!==k.Loaded)continue;if(e.p2pManager.getActiveDownloadsCount()>=e.settings.simultaneousP2PDownloads)for(let t=e.segmentsQueue.length-1;t>s;t--){const n=e.segmentsQueue[t];if(e.p2pManager.isDownloading(n)){e.debugSegments("cancel P2P download",n.priority,n.url),e.p2pManager.abort(n);break}}if(e.p2pManager.getActiveDownloadsCount()<e.settings.simultaneousP2PDownloads&&e.p2pManager.download(i)){e.debugSegments("P2P download (priority)",i.priority,i.url);continue}}else e.p2pManager.getActiveDownloadsCount()<e.settings.simultaneousP2PDownloads&&i.priority<=e.settings.p2pDownloadMaxPriority&&e.p2pManager.download(i)&&e.debugSegments("P2P download",i.priority,i.url)}}return r},e.downloadRandomSegmentOverHttp=()=>(0,o.mG)(we(e),void 0,void 0,(function*(){if(void 0===this.masterSwarmId||void 0===this.httpRandomDownloadInterval||this.httpDownloadInitialTimeoutTimestamp!==-1/0||this.httpManager.getActiveDownloadsCount()>=this.settings.simultaneousHttpDownloads||this.settings.httpDownloadProbabilitySkipIfNoPeers&&0===this.p2pManager.getPeers().size||this.settings.consumeOnly)return;const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId),t=this.p2pManager.getOverallSegmentsMap(),n=this.segmentsQueue.filter((n=>!this.p2pManager.isDownloading(n)&&!this.httpManager.isDownloading(n)&&!t.has(n.id)&&!this.httpManager.isFailed(n)&&n.priority<=this.settings.httpDownloadMaxPriority&&!e.has(n.id)));if(0===n.length)return;if(Math.random()>this.settings.httpDownloadProbability*n.length)return;const r=n[Math.floor(Math.random()*n.length)];this.debugSegments("HTTP download (random)",r.priority,r.url),this.httpManager.download(r),this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))})),e.onSegmentStartLoad=(t,n)=>{e.emit(r.SegmentStartLoad,t,n)},e.onPieceBytesDownloaded=(t,n,o,s)=>{e.bandwidthApproximator.addBytes(o,e.now()),e.emit(r.PieceBytesDownloaded,t,n,o,s)},e.onPieceBytesUploaded=(t,n,o,s)=>{e.emit(r.PieceBytesUploaded,t,n,o,s)},e.onSegmentLoaded=(t,n,s)=>(0,o.mG)(we(e),void 0,void 0,(function*(){if(this.debugSegments("segment loaded",t.id,t.url),void 0===this.masterSwarmId)return;t.data=n,t.downloadBandwidth=this.bandwidthApproximator.getBandwidth(this.now()),yield this.segmentsStorage.storeSegment(t),this.emit(r.SegmentLoaded,t,s);const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e),this.settings.consumeOnly||this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))})),e.onSegmentError=(t,n,s)=>(0,o.mG)(we(e),void 0,void 0,(function*(){if(this.debugSegments("segment error",t.id,t.url,s,n),this.emit(r.SegmentError,t,n,s),void 0!==this.masterSwarmId){const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}})),e.onSegmentSize=(t,n)=>(0,o.mG)(we(e),void 0,void 0,(function*(){this.debugSegments("segment size",t.id,n),this.emit(r.SegmentSize,t,n)})),e.getStreamSwarmId=e=>void 0===e.streamId?e.masterSwarmId:`${e.masterSwarmId}+${e.streamId}`,e.createSegmentsMap=t=>{const n={},r=(t,r)=>{const o=e.getStreamSwarmId(t),s=t.sequence;let i=n[o];void 0===i&&(i=["",[]],n[o]=i);const a=i[1];i[0]+=0===a.length?s:`|${s}`,a.push(r)};for(const e of t.values())r(e.segment,k.Loaded);for(const t of e.httpManager.getActiveDownloads().values())r(t.segment,k.LoadingByHttp);return n},e.onPeerConnect=t=>(0,o.mG)(we(e),void 0,void 0,(function*(){this.emit(r.PeerConnect,t),this.settings.consumeOnly||void 0===this.masterSwarmId||this.p2pManager.sendSegmentsMap(t.id,this.createSegmentsMap(yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId)))})),e.onPeerClose=t=>{e.emit(r.PeerClose,t)},e.onTrackerUpdate=t=>(0,o.mG)(we(e),void 0,void 0,(function*(){if(this.httpDownloadInitialTimeoutTimestamp!==-1/0&&void 0!==t.incomplete&&t.incomplete<=1&&(this.debugSegments("cancel initial HTTP download timeout - no peers"),this.httpDownloadInitialTimeoutTimestamp=-1/0,void 0!==this.masterSwarmId)){const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}})),e.cleanSegmentsStorage=()=>(0,o.mG)(we(e),void 0,void 0,(function*(){return void 0!==this.masterSwarmId&&this.segmentsStorage.clean(this.masterSwarmId,(e=>void 0!==this.segmentsQueue.find((t=>t.id===e))))})),e.now=()=>performance.now(),e.settings=Object.assign(Object.assign({},ve),t);const{bufferedSegmentsCount:n}=t;return"number"==typeof n&&(void 0===t.p2pDownloadMaxPriority&&(e.settings.p2pDownloadMaxPriority=n),void 0===t.httpDownloadMaxPriority&&(e.settings.p2pDownloadMaxPriority=n)),e.segmentsStorage=void 0===e.settings.segmentsStorage?new me(e.settings):e.settings.segmentsStorage,e.debug("loader settings",e.settings),e.httpManager=e.createHttpManager(),e.httpManager.on("segment-start-load",(t=>e.onSegmentStartLoad("http",t))),e.httpManager.on("segment-loaded",e.onSegmentLoaded),e.httpManager.on("segment-error",e.onSegmentError),e.httpManager.on("segment-size",e.onSegmentSize),e.httpManager.on("bytes-downloaded",((t,n)=>{e.onPieceBytesDownloaded("http",t,n)})),e.p2pManager=e.createP2PManager(),e.p2pManager.on("segment-start-load",(t=>e.onSegmentStartLoad("p2p",t))),e.p2pManager.on("segment-loaded",e.onSegmentLoaded),e.p2pManager.on("segment-error",e.onSegmentError),e.p2pManager.on("segment-size",e.onSegmentSize),e.p2pManager.on("peer-data-updated",(()=>(0,o.mG)(we(e),void 0,void 0,(function*(){if(void 0===this.masterSwarmId)return;const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))})))),e.p2pManager.on("bytes-downloaded",((t,n,r)=>e.onPieceBytesDownloaded("p2p",t,n,r))),e.p2pManager.on("bytes-uploaded",((t,n,r)=>e.onPieceBytesUploaded("p2p",t,n,r))),e.p2pManager.on("peer-connected",e.onPeerConnect),e.p2pManager.on("peer-closed",e.onPeerClose),e.p2pManager.on("tracker-update",e.onTrackerUpdate),e}return t=l,n&&pe(t.prototype,n),s&&pe(t,s),Object.defineProperty(t,"prototype",{writable:!1}),t}(a.EventEmitter);Pe.isSupported=()=>void 0!==window.RTCPeerConnection.prototype.createDataChannel},9502:(e,t,n)=>{"use strict";n.r(t),n.d(t,{Engine:()=>T,SegmentManager:()=>p,initClapprPlayer:()=>q,initFlowplayerHlsJsPlayer:()=>D,initHlsJsPlayer:()=>C,initJwPlayer:()=>A,initMediaElementJsPlayer:()=>j,initVideoJsContribHlsJsPlayer:()=>k,initVideoJsHlsJsPlugin:()=>E,version:()=>O});var r=n(649),o=n(5101),s=n(3819),i=n(51);function a(e){return e.rangeEnd&&void 0!==e.rangeStart?{offset:e.rangeStart,length:e.rangeEnd-e.rangeStart}:void 0}function l(e,t){return void 0===e?void 0===t:void 0!==t&&e.length===t.length&&e.offset===t.offset}function d(e){if(void 0===e)return;const t=e.offset+e.length-1;return`bytes=${e.offset}-${t}`}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&g(e.prototype,t),n&&g(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}const m={forwardSegmentCount:20,swarmId:void 0,assetsStorage:void 0};let p=function(){function e(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};u(this,e),this.masterPlaylist=null,this.variantPlaylists=new Map,this.segmentRequest=null,this.fetch=function(){return fetch.apply(void 0,arguments)},this.playQueue=[],this.onSegmentLoaded=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&d(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onSuccess(e.data.slice(0),e.downloadBandwidth),this.segmentRequest=null)},this.onSegmentError=(e,t)=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&d(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onError(t),this.segmentRequest=null)},this.onSegmentAbort=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&d(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onError("Loading aborted: internal abort"),this.segmentRequest=null)},this.settings=Object.assign(Object.assign({},m),n.segments),this.loader=t,this.loader.on(s.zW.SegmentLoaded,this.onSegmentLoaded),this.loader.on(s.zW.SegmentError,this.onSegmentError),this.loader.on(s.zW.SegmentAbort,this.onSegmentAbort),n.loader&&n.loader.localTransport&&(this.fetch=n.loader.localTransport)}return c(e,[{key:"getSettings",value:function(){return this.settings}},{key:"processPlaylist",value:function(e,t,n){const r=new i._b;r.push(t),r.end();const o=new f(e,n,r.manifest);if(o.manifest.playlists){this.masterPlaylist=o;for(const[e,t]of this.variantPlaylists){const{streamSwarmId:n,found:r,index:o}=this.getStreamSwarmId(t.requestUrl);r?(t.streamSwarmId=n,t.streamId="V"+o.toString()):this.variantPlaylists.delete(e)}}else{const{streamSwarmId:t,found:n,index:r}=this.getStreamSwarmId(e);(n||null===this.masterPlaylist)&&(o.streamSwarmId=t,o.streamId=null===this.masterPlaylist?void 0:"V"+r.toString(),this.variantPlaylists.set(e,o),this.updateSegments())}}},{key:"loadPlaylist",value:function(e){return(0,r.mG)(this,void 0,void 0,(function*(){const t=this.settings.assetsStorage;let n;if(void 0!==t){let r;r=this.getMasterSwarmId(),void 0===r&&(r=e.split("?")[0]);const o=yield t.getAsset(e,void 0,r);if(void 0!==o)n={responseURL:o.responseUri,response:o.data};else{const o=yield this.loadContent(e);n={responseURL:o.url,response:yield o.text()},t.storeAsset({masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e,masterSwarmId:r,requestUri:e,responseUri:n.responseURL,data:yield n.response})}}else{const t=yield this.loadContent(e);n={responseURL:t.url,response:yield t.text()}}return this.processPlaylist(e,n.response,n.responseURL),n}))}},{key:"loadSegment",value:function(e,t){var n;return(0,r.mG)(this,void 0,void 0,(function*(){const r=this.getSegmentLocation(e,t),o=d(t);if(!r){let t;const r=this.settings.assetsStorage;if(void 0!==r){let s,i=null===(n=this.masterPlaylist)||void 0===n?void 0:n.requestUrl;if(s=this.getMasterSwarmId(),void 0===s&&1===this.variantPlaylists.size){const e=this.variantPlaylists.values().next();e.done||(s=e.value.requestUrl.split("?")[0])}if(void 0===i&&1===this.variantPlaylists.size){const e=this.variantPlaylists.values().next();e.done||(i=e.value.requestUrl)}if(void 0!==s&&void 0!==i){const n=yield r.getAsset(e,o,s);if(void 0!==n)t=n.data;else{const n=yield this.loadContent(e,o);t=yield n.arrayBuffer(),r.storeAsset({masterManifestUri:i,masterSwarmId:s,requestUri:e,requestRange:o,responseUri:n.url,data:t})}}}if(void 0===t){const n=yield this.loadContent(e,o);t=yield n.arrayBuffer()}return{content:t,downloadBandwidth:0}}const s=(r.playlist.manifest.mediaSequence?r.playlist.manifest.mediaSequence:0)+r.segmentIndex;if(this.playQueue.length>0){this.playQueue[this.playQueue.length-1].segmentSequence!==s-1&&(this.playQueue=[])}this.segmentRequest&&this.segmentRequest.onError("Cancel segment request: simultaneous segment requests are not supported");const i=new Promise(((n,o)=>{this.segmentRequest=new h(e,t,s,r.playlist.requestUrl,((e,t)=>n({content:e,downloadBandwidth:t})),(e=>o(e)))}));return this.playQueue.push({segmentUrl:e,segmentByteRange:t,segmentSequence:s}),this.loadSegments(r.playlist,r.segmentIndex,!0),i}))}},{key:"setPlayingSegment",value:function(e,t,n,r){const o=this.playQueue.findIndex((n=>n.segmentUrl===e&&l(n.segmentByteRange,t)));o>=0&&(this.playQueue=this.playQueue.slice(o),this.playQueue[0].playPosition={start:n,duration:r},this.updateSegments())}},{key:"setPlayingSegmentByCurrentTime",value:function(e){if(0===this.playQueue.length||!this.playQueue[0].playPosition)return;const t=this.playQueue[0].playPosition;t.start+t.duration-e<.2&&(this.playQueue=this.playQueue.slice(1),this.updateSegments())}},{key:"abortSegment",value:function(e,t){this.segmentRequest&&this.segmentRequest.segmentUrl===e&&l(this.segmentRequest.segmentByteRange,t)&&(this.segmentRequest.onSuccess(void 0,0),this.segmentRequest=null)}},{key:"destroy",value:function(){return(0,r.mG)(this,void 0,void 0,(function*(){this.segmentRequest&&(this.segmentRequest.onError("Loading aborted: object destroyed"),this.segmentRequest=null),this.masterPlaylist=null,this.variantPlaylists.clear(),this.playQueue=[],void 0!==this.settings.assetsStorage&&(yield this.settings.assetsStorage.destroy()),yield this.loader.destroy()}))}},{key:"updateSegments",value:function(){if(!this.segmentRequest)return;const e=this.getSegmentLocation(this.segmentRequest.segmentUrl,this.segmentRequest.segmentByteRange);e&&this.loadSegments(e.playlist,e.segmentIndex,!1)}},{key:"getSegmentLocation",value:function(e,t){for(const n of this.variantPlaylists.values()){const r=n.getSegmentIndex(e,t);if(r>=0)return{playlist:n,segmentIndex:r}}}},{key:"loadSegments",value:function(e,t,n){var o;return(0,r.mG)(this,void 0,void 0,(function*(){const r=[],s=e.manifest.segments,i=null!==(o=e.manifest.mediaSequence)&&void 0!==o?o:0;let a=null,l=Math.max(0,this.playQueue.length-1);const u=this.getMasterSwarmId();for(let o=t;o<s.length&&r.length<this.settings.forwardSegmentCount;++o){const t=e.manifest.segments[o],s=e.getSegmentAbsoluteUrl(t.uri),g=t.byterange,c=this.getSegmentId(e,i+o);r.push({id:c,url:s,masterSwarmId:void 0!==u?u:e.streamSwarmId,masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e.requestUrl,streamId:e.streamId,sequence:(i+o).toString(),range:d(g),priority:l++}),n&&!a&&(a=c)}if(this.loader.load(r,e.streamSwarmId),a){const e=yield this.loader.getSegment(a);e&&this.onSegmentLoaded(e)}}))}},{key:"getSegmentId",value:function(e,t){return`${e.streamSwarmId}+${t}`}},{key:"getMasterSwarmId",value:function(){const e=this.settings.swarmId&&0!==this.settings.swarmId.length?this.settings.swarmId:void 0;return void 0!==e?e:null!==this.masterPlaylist?this.masterPlaylist.requestUrl.split("?")[0]:void 0}},{key:"getStreamSwarmId",value:function(e){const t=this.getMasterSwarmId();if(this.masterPlaylist&&this.masterPlaylist.manifest.playlists&&t)for(let n=0;n<this.masterPlaylist.manifest.playlists.length;++n){if(new URL(this.masterPlaylist.manifest.playlists[n].uri,this.masterPlaylist.responseUrl).toString()===e)return{streamSwarmId:`${t}+V${n}`,found:!0,index:n}}return{streamSwarmId:null!=t?t:e.split("?")[0],found:!1,index:-1}}},{key:"loadContent",value:function(e,t){return(0,r.mG)(this,void 0,void 0,(function*(){const n=new Headers;t&&n.append("Range",t);const r=this.fetch(e,{headers:n});return r.catch((e=>{})),r}))}}]),e}(),f=function(){function e(t,n,r){u(this,e),this.requestUrl=t,this.responseUrl=n,this.manifest=r,this.streamSwarmId=""}return c(e,[{key:"getSegmentIndex",value:function(e,t){for(let n=0;n<this.manifest.segments.length;++n){const r=this.manifest.segments[n];if(e===this.getSegmentAbsoluteUrl(r.uri)&&l(r.byterange,t))return n}return-1}},{key:"getSegmentAbsoluteUrl",value:function(e){return new URL(e,this.responseUrl).toString()}}]),e}(),h=c((function e(t,n,r,o,s,i){u(this,e),this.segmentUrl=t,this.segmentByteRange=n,this.segmentSequence=r,this.playlistRequestUrl=o,this.onSuccess=s,this.onError=i}));function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}let S=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.isLoaded=!1,this.stats={loaded:0,total:0,aborted:!1,retry:0,chunkCount:0,bwEstimate:0,loading:{start:0,end:0,first:0},parsing:{start:0,end:0},buffering:{start:0,end:0,first:0}},this.segmentManager=t}var t,n,o;return t=e,o=[{key:"updateStatsToStartLoading",value:function(e){const t=performance.now();e.loading.start=t,e.loading.first=t}}],(n=[{key:"load",value:function(t,n,o){return(0,r.mG)(this,void 0,void 0,(function*(){if(e.updateStatsToStartLoading(this.stats),t.type)try{const e=yield this.segmentManager.loadPlaylist(t.url);this.isLoaded=!0,this.successPlaylist(e,t,o)}catch(e){this.error(e,t,o)}else if(t.frag){const{loader:n}=this.segmentManager,r=a(t),i=e=>e.url===t.url&&e.range===d(r);let l=setInterval((()=>{e.updateStatsToStartLoading(this.stats)}),200);const u=(e,t)=>{i(e)&&(this.stats.total=t)};n.on(s.zW.SegmentSize,u);const g=(e,t,n)=>{i(t)&&(this.stats.loaded+=n)},c=(t,r)=>{l&&"http"===t&&i(r)&&(clearInterval(l),l=void 0,e.updateStatsToStartLoading(this.stats),n.on(s.zW.PieceBytesDownloaded,g))};n.on(s.zW.SegmentStartLoad,c);try{const e=yield this.segmentManager.loadSegment(t.url,r),{content:i}=e;i&&(this.isLoaded=!0,setTimeout((()=>this.successSegment(i,t,o)),0))}catch(e){setTimeout((()=>this.error(e,t,o)),0)}finally{clearInterval(l),n.off(s.zW.SegmentStartLoad,c),n.off(s.zW.SegmentSize,u),n.off(s.zW.PieceBytesDownloaded,g)}}else console.warn("Unknown load request",t)}))}},{key:"abort",value:function(e,t){if(this.isLoaded)return;this.segmentManager.abortSegment(e.url,a(e)),this.stats.aborted=!0;const n=null==t?void 0:t.onAbort;n&&n(this.stats,e,void 0)}},{key:"successPlaylist",value:function(e,t,n){const r=performance.now();this.stats.loading.end=r,this.stats.loaded=e.response.length,this.stats.total=e.response.length,n.onSuccess({url:e.responseURL,data:e.response},this.stats,t,void 0)}},{key:"successSegment",value:function(e,t,n){const r=performance.now();this.stats.loading.end=r,this.stats.loaded=e.byteLength,this.stats.total=e.byteLength,n.onProgress&&n.onProgress(this.stats,t,e,void 0),n.onSuccess({url:t.url,data:e},this.stats,t,void 0)}},{key:"error",value:function(e,t,n){n.onError(e,t,void 0)}}])&&y(t.prototype,n),o&&y(t,o),Object.defineProperty(t,"prototype",{writable:!1}),e}();function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t&&b(e.prototype,t),n&&b(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function P(e,t){return P=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},P(e,t)}function R(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I(e);if(t){var o=I(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return M(this,n)}}function M(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function I(e){return I=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},I(e)}let T=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&P(e,t)}(n,e);var t=R(n);function n(){var e;let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return w(this,n),(e=t.call(this)).loader=new s.ou(r.loader),e.segmentManager=new p(e.loader,r),Object.keys(s.zW).map((e=>s.zW[e])).forEach((t=>e.loader.on(t,(function(){for(var n,r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return(n=e).emit.apply(n,[t].concat(o))})))),e}return v(n,[{key:"createLoaderClass",value:function(){var e;const t=this;return(e=v((function e(){w(this,e),this.load=(e,t,n)=>(0,r.mG)(this,void 0,void 0,(function*(){this.context=e,this.callbacks=n,this.impl.load(e,t,n)})),this.abort=()=>{this.context&&this.impl.abort(this.context,this.callbacks)},this.destroy=()=>{this.context&&this.impl.abort(this.context)},this.getResponseHeader=()=>{},this.impl=new S(t.segmentManager),this.stats=this.impl.stats}))).getEngine=()=>t,e}},{key:"destroy",value:function(){return(0,r.mG)(this,void 0,void 0,(function*(){yield this.segmentManager.destroy()}))}},{key:"getSettings",value:function(){return{segments:this.segmentManager.getSettings(),loader:this.loader.getSettings()}}},{key:"getDetails",value:function(){return{loader:this.loader.getDetails()}}},{key:"setPlayingSegment",value:function(e,t,n,r){this.segmentManager.setPlayingSegment(e,t,n,r)}},{key:"setPlayingSegmentByCurrentTime",value:function(e){this.segmentManager.setPlayingSegmentByCurrentTime(e)}}],[{key:"isSupported",value:function(){return s.ou.isSupported()}}]),n}(o.EventEmitter);const O="0.6.2";function C(e){e&&e.config&&e.config.loader&&"function"==typeof e.config.loader.getEngine&&B(e,e.config.loader.getEngine())}function q(e){e.on("play",(()=>{const t=e.core.getCurrentPlayback();t._hls&&!t._hls._p2pm_linitialized&&(t._hls._p2pm_linitialized=!0,C(e.core.getCurrentPlayback()._hls))}))}function D(e){e.on("ready",(()=>{var t;return C(null!==(t=e.engine.hlsjs)&&void 0!==t?t:e.engine.hls)}))}function k(e){e.ready((()=>{const t=e.tech_.options_;t&&t.hlsjsConfig&&t.hlsjsConfig.loader&&"function"==typeof t.hlsjsConfig.loader.getEngine&&B(e.tech_,t.hlsjsConfig.loader.getEngine())}))}function E(){null!=videojs&&null!=videojs.Html5Hlsjs&&videojs.Html5Hlsjs.addHook("beforeinitialize",((e,t)=>{t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine&&B(t,t.config.loader.getEngine())}))}function j(e){e.addEventListener("hlsFragChanged",(t=>{const n=e.hlsPlayer;if(n&&n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine){const e=n.config.loader.getEngine();if(t.data&&t.data.length>1){const n=t.data[1].frag,r=2!==n.byteRange.length?void 0:{offset:n.byteRange[0],length:n.byteRange[1]-n.byteRange[0]};e.setPlayingSegment(n.url,r,n.start,n.duration)}}})),e.addEventListener("hlsDestroying",(()=>(0,r.mG)(this,void 0,void 0,(function*(){const t=e.hlsPlayer;if(t&&t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine){const e=t.config.loader.getEngine();yield e.destroy()}})))),e.addEventListener("hlsError",(t=>{const n=e.hlsPlayer;if(n&&n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine&&void 0!==t.data&&"bufferStalledError"===t.data.details){n.config.loader.getEngine().setPlayingSegmentByCurrentTime(n.media.currentTime)}}))}function A(e,t){const n=setInterval((()=>{e.hls&&e.hls.config&&(clearInterval(n),Object.assign(e.hls.config,t),C(e.hls))}),200)}function B(e,t){e.on("hlsFragChanged",((e,n)=>{const r=n.frag,o=2!==r.byteRange.length?void 0:{offset:r.byteRange[0],length:r.byteRange[1]-r.byteRange[0]};t.setPlayingSegment(r.url,o,r.start,r.duration)})),e.on("hlsDestroying",(()=>(0,r.mG)(this,void 0,void 0,(function*(){yield t.destroy()})))),e.on("hlsError",((n,r)=>{if("bufferStalledError"===r.details){const n=void 0===e.media?e.el_:e.media;n&&t.setPlayingSegmentByCurrentTime(n.currentTime)}}))}},9354:()=>{},3762:()=>{},8333:()=>{},59:()=>{},2361:()=>{},4616:()=>{},3719:()=>{}}]);
//# sourceMappingURL=795.chunk.js.map